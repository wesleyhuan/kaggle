{
 "cells": [
  {
   "cell_type": "markdown",
   "id": "bd5deec9",
   "metadata": {
    "papermill": {
     "duration": 0.004234,
     "end_time": "2026-01-19T13:55:06.258847",
     "exception": false,
     "start_time": "2026-01-19T13:55:06.254613",
     "status": "completed"
    },
    "tags": []
   },
   "source": [
    "# Outline\n",
    "\n",
    "This notebook include model training process and with optuna hyperparameter finding.\n",
    "\n",
    "Preprocess and feature Engineering is base on previous notebook.\n",
    "\n",
    "link : [https://www.kaggle.com/code/wesleyhuan/beginer-level-eda-season-6-episode-1](http://)\n",
    "\n",
    "Include these steps:\n",
    "\n",
    "* Load data\n",
    "* Preprocess data\n",
    "* Train model with Hyper parameter (OPTUNA)\n",
    "* Submission"
   ]
  },
  {
   "cell_type": "markdown",
   "id": "3910d7cc",
   "metadata": {
    "papermill": {
     "duration": 0.002705,
     "end_time": "2026-01-19T13:55:06.264512",
     "exception": false,
     "start_time": "2026-01-19T13:55:06.261807",
     "status": "completed"
    },
    "tags": []
   },
   "source": [
    "# Load data"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 1,
   "id": "a0acde7c",
   "metadata": {
    "execution": {
     "iopub.execute_input": "2026-01-19T13:55:06.271889Z",
     "iopub.status.busy": "2026-01-19T13:55:06.271591Z",
     "iopub.status.idle": "2026-01-19T13:55:20.255555Z",
     "shell.execute_reply": "2026-01-19T13:55:20.254915Z"
    },
    "papermill": {
     "duration": 13.989934,
     "end_time": "2026-01-19T13:55:20.257399",
     "exception": false,
     "start_time": "2026-01-19T13:55:06.267465",
     "status": "completed"
    },
    "tags": []
   },
   "outputs": [
    {
     "name": "stderr",
     "output_type": "stream",
     "text": [
      "/usr/local/lib/python3.12/dist-packages/sqlalchemy/orm/query.py:195: SyntaxWarning: \"is not\" with 'tuple' literal. Did you mean \"!=\"?\n",
      "  if entities is not ():\n"
     ]
    }
   ],
   "source": [
    "# import necessary library\n",
    "import numpy as np # linear algebra\n",
    "import pandas as pd # data processing, CSV file I/O (e.g. pd.read_csv)\n",
    "import matplotlib.pyplot as plt\n",
    "import seaborn as sns\n",
    "\n",
    "from sklearn.preprocessing import OrdinalEncoder,LabelEncoder\n",
    "\n",
    "from xgboost import XGBRegressor\n",
    "from sklearn.metrics import mean_squared_error\n",
    "from sklearn.model_selection import train_test_split\n",
    "\n",
    "#for optuna pipline\n",
    "import optuna\n",
    "from sklearn.pipeline import Pipeline\n",
    "from sklearn.model_selection import KFold, cross_val_score\n",
    "from sklearn.base import BaseEstimator, TransformerMixin\n",
    "import torch"
   ]
  },
  {
   "cell_type": "markdown",
   "id": "82c15459",
   "metadata": {
    "papermill": {
     "duration": 0.002986,
     "end_time": "2026-01-19T13:55:20.263663",
     "exception": false,
     "start_time": "2026-01-19T13:55:20.260677",
     "status": "completed"
    },
    "tags": []
   },
   "source": [
    "# Load data"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 2,
   "id": "e18222b8",
   "metadata": {
    "execution": {
     "iopub.execute_input": "2026-01-19T13:55:20.271214Z",
     "iopub.status.busy": "2026-01-19T13:55:20.270471Z",
     "iopub.status.idle": "2026-01-19T13:55:20.360702Z",
     "shell.execute_reply": "2026-01-19T13:55:20.359808Z"
    },
    "papermill": {
     "duration": 0.095541,
     "end_time": "2026-01-19T13:55:20.362068",
     "exception": false,
     "start_time": "2026-01-19T13:55:20.266527",
     "status": "completed"
    },
    "tags": []
   },
   "outputs": [
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "now using cuda\n"
     ]
    }
   ],
   "source": [
    "# config\n",
    "class CFG:\n",
    "    train_csv = '/kaggle/input/playground-series-s6e1/train.csv'\n",
    "    test_csv = '/kaggle/input/playground-series-s6e1/test.csv'\n",
    "    sample_submission_csv = '/kaggle/input/playground-series-s6e1/sample_submission.csv'\n",
    "    N_FOLDS = 5\n",
    "    RANDOM_SEED = 42\n",
    "    \n",
    "#torch.device('cuda' if torch.cuda.is_available() else 'cpu')\n",
    "device = 'cuda' if torch.cuda.is_available() else 'cpu'\n",
    "print(f\"now using {device}\")"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 3,
   "id": "2eaf4092",
   "metadata": {
    "execution": {
     "iopub.execute_input": "2026-01-19T13:55:20.369500Z",
     "iopub.status.busy": "2026-01-19T13:55:20.369081Z",
     "iopub.status.idle": "2026-01-19T13:55:21.841561Z",
     "shell.execute_reply": "2026-01-19T13:55:21.840758Z"
    },
    "papermill": {
     "duration": 1.477948,
     "end_time": "2026-01-19T13:55:21.843303",
     "exception": false,
     "start_time": "2026-01-19T13:55:20.365355",
     "status": "completed"
    },
    "tags": []
   },
   "outputs": [],
   "source": [
    "train = pd.read_csv(CFG.train_csv)\n",
    "test = pd.read_csv(CFG.test_csv)"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 4,
   "id": "e90eb944",
   "metadata": {
    "execution": {
     "iopub.execute_input": "2026-01-19T13:55:21.850889Z",
     "iopub.status.busy": "2026-01-19T13:55:21.850383Z",
     "iopub.status.idle": "2026-01-19T13:55:21.881067Z",
     "shell.execute_reply": "2026-01-19T13:55:21.880309Z"
    },
    "papermill": {
     "duration": 0.035961,
     "end_time": "2026-01-19T13:55:21.882502",
     "exception": false,
     "start_time": "2026-01-19T13:55:21.846541",
     "status": "completed"
    },
    "tags": []
   },
   "outputs": [
    {
     "data": {
      "text/html": [
       "<div>\n",
       "<style scoped>\n",
       "    .dataframe tbody tr th:only-of-type {\n",
       "        vertical-align: middle;\n",
       "    }\n",
       "\n",
       "    .dataframe tbody tr th {\n",
       "        vertical-align: top;\n",
       "    }\n",
       "\n",
       "    .dataframe thead th {\n",
       "        text-align: right;\n",
       "    }\n",
       "</style>\n",
       "<table border=\"1\" class=\"dataframe\">\n",
       "  <thead>\n",
       "    <tr style=\"text-align: right;\">\n",
       "      <th></th>\n",
       "      <th>id</th>\n",
       "      <th>age</th>\n",
       "      <th>gender</th>\n",
       "      <th>course</th>\n",
       "      <th>study_hours</th>\n",
       "      <th>class_attendance</th>\n",
       "      <th>internet_access</th>\n",
       "      <th>sleep_hours</th>\n",
       "      <th>sleep_quality</th>\n",
       "      <th>study_method</th>\n",
       "      <th>facility_rating</th>\n",
       "      <th>exam_difficulty</th>\n",
       "    </tr>\n",
       "  </thead>\n",
       "  <tbody>\n",
       "    <tr>\n",
       "      <th>0</th>\n",
       "      <td>630000</td>\n",
       "      <td>24</td>\n",
       "      <td>other</td>\n",
       "      <td>ba</td>\n",
       "      <td>6.85</td>\n",
       "      <td>65.2</td>\n",
       "      <td>yes</td>\n",
       "      <td>5.2</td>\n",
       "      <td>poor</td>\n",
       "      <td>group study</td>\n",
       "      <td>high</td>\n",
       "      <td>easy</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>1</th>\n",
       "      <td>630001</td>\n",
       "      <td>18</td>\n",
       "      <td>male</td>\n",
       "      <td>diploma</td>\n",
       "      <td>6.61</td>\n",
       "      <td>45.0</td>\n",
       "      <td>no</td>\n",
       "      <td>9.3</td>\n",
       "      <td>poor</td>\n",
       "      <td>coaching</td>\n",
       "      <td>low</td>\n",
       "      <td>easy</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>2</th>\n",
       "      <td>630002</td>\n",
       "      <td>24</td>\n",
       "      <td>female</td>\n",
       "      <td>b.tech</td>\n",
       "      <td>6.60</td>\n",
       "      <td>98.5</td>\n",
       "      <td>yes</td>\n",
       "      <td>6.2</td>\n",
       "      <td>good</td>\n",
       "      <td>group study</td>\n",
       "      <td>medium</td>\n",
       "      <td>moderate</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>3</th>\n",
       "      <td>630003</td>\n",
       "      <td>24</td>\n",
       "      <td>male</td>\n",
       "      <td>diploma</td>\n",
       "      <td>3.03</td>\n",
       "      <td>66.3</td>\n",
       "      <td>yes</td>\n",
       "      <td>5.7</td>\n",
       "      <td>average</td>\n",
       "      <td>mixed</td>\n",
       "      <td>medium</td>\n",
       "      <td>moderate</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>4</th>\n",
       "      <td>630004</td>\n",
       "      <td>20</td>\n",
       "      <td>female</td>\n",
       "      <td>b.tech</td>\n",
       "      <td>2.03</td>\n",
       "      <td>42.4</td>\n",
       "      <td>yes</td>\n",
       "      <td>9.2</td>\n",
       "      <td>average</td>\n",
       "      <td>coaching</td>\n",
       "      <td>low</td>\n",
       "      <td>moderate</td>\n",
       "    </tr>\n",
       "  </tbody>\n",
       "</table>\n",
       "</div>"
      ],
      "text/plain": [
       "       id  age  gender   course  study_hours  class_attendance  \\\n",
       "0  630000   24   other       ba         6.85              65.2   \n",
       "1  630001   18    male  diploma         6.61              45.0   \n",
       "2  630002   24  female   b.tech         6.60              98.5   \n",
       "3  630003   24    male  diploma         3.03              66.3   \n",
       "4  630004   20  female   b.tech         2.03              42.4   \n",
       "\n",
       "  internet_access  sleep_hours sleep_quality study_method facility_rating  \\\n",
       "0             yes          5.2          poor  group study            high   \n",
       "1              no          9.3          poor     coaching             low   \n",
       "2             yes          6.2          good  group study          medium   \n",
       "3             yes          5.7       average        mixed          medium   \n",
       "4             yes          9.2       average     coaching             low   \n",
       "\n",
       "  exam_difficulty  \n",
       "0            easy  \n",
       "1            easy  \n",
       "2        moderate  \n",
       "3        moderate  \n",
       "4        moderate  "
      ]
     },
     "execution_count": 4,
     "metadata": {},
     "output_type": "execute_result"
    }
   ],
   "source": [
    "test.head()"
   ]
  },
  {
   "cell_type": "markdown",
   "id": "f4342432",
   "metadata": {
    "papermill": {
     "duration": 0.00311,
     "end_time": "2026-01-19T13:55:21.888706",
     "exception": false,
     "start_time": "2026-01-19T13:55:21.885596",
     "status": "completed"
    },
    "tags": []
   },
   "source": [
    "# Preprocess data\n",
    "\n",
    "2026/01/13\n",
    "change into class for pipline"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 5,
   "id": "4d11d53b",
   "metadata": {
    "execution": {
     "iopub.execute_input": "2026-01-19T13:55:21.895735Z",
     "iopub.status.busy": "2026-01-19T13:55:21.895493Z",
     "iopub.status.idle": "2026-01-19T13:55:21.906566Z",
     "shell.execute_reply": "2026-01-19T13:55:21.905890Z"
    },
    "papermill": {
     "duration": 0.016305,
     "end_time": "2026-01-19T13:55:21.907987",
     "exception": false,
     "start_time": "2026-01-19T13:55:21.891682",
     "status": "completed"
    },
    "tags": []
   },
   "outputs": [],
   "source": [
    "class Preprocessor(BaseEstimator, TransformerMixin):\n",
    "    def __init__(self):\n",
    "        self.medians = {}\n",
    "        self.encoders = {}\n",
    "        self.numeric_cols = []\n",
    "        self.all_non_numeric = []\n",
    "        self.categorical_cols = []\n",
    "        self.level_mapping = {'easy': 1, 'moderate': 2, 'hard': 3,\n",
    "                              'low': 1, 'medium': 2, 'high': 3,\n",
    "                              'poor': 1, 'average': 2, 'good': 3}\n",
    "        self.level_cols = ['sleep_quality', 'facility_rating', 'exam_difficulty']\n",
    "        \n",
    "    def fit(self, df, y=None):\n",
    "        \"\"\"\n",
    "        Learn the parameters (medians, categories) from the TRAINING data.\n",
    "        \"\"\"\n",
    "        # Identify columns\n",
    "        self.numeric_cols = df.select_dtypes(include=[np.number]).columns.tolist()\n",
    "        self.all_non_numeric = df.select_dtypes(exclude=[np.number]).columns.tolist()\n",
    "        self.categorical_cols = [c for c in self.all_non_numeric if c not in self.level_cols]\n",
    "        \n",
    "        # Learn Medians for numeric columns\n",
    "        for col in self.numeric_cols:\n",
    "            self.medians[col] = df[col].median()\n",
    "            \n",
    "        # Fit Encoders for categorical columns\n",
    "        # handle_unknown='use_encoded_value' prevents crashes if Test data has new categories\n",
    "        for col in self.categorical_cols:\n",
    "            enc = OrdinalEncoder(handle_unknown='use_encoded_value', unknown_value=-1)\n",
    "            enc.fit(df[[col]].astype(str)) \n",
    "            self.encoders[col] = enc\n",
    "            \n",
    "        return self\n",
    "\n",
    "    def transform(self, df):\n",
    "        \"\"\"\n",
    "        Apply the learned parameters to the data (Train or Test).\n",
    "        \"\"\"\n",
    "        df = df.copy()\n",
    "        \n",
    "        # Drop irrelevant columns (ID is usually dropped, Target handled separately)\n",
    "        # Note: We don't drop target here to keep X and y aligned until the end\n",
    "        cols_to_drop = ['id', 'exam_score']\n",
    "        df = df.drop(columns=[c for c in cols_to_drop if c in df.columns])\n",
    "\n",
    "        # level encoding\n",
    "        for col in self.level_cols:\n",
    "            if col in df.columns:\n",
    "                # ues mapping rule fillna with 0 \n",
    "                df[col] = df[col].map(self.level_mapping).fillna(0).astype(int)\n",
    "        # Impute Missing Values using LEARNED medians\n",
    "        for col in self.numeric_cols:\n",
    "            if col in df.columns:\n",
    "                df[col] = df[col].fillna(self.medians.get(col, 0))\n",
    "        \n",
    "        # Apply Encoding\n",
    "        for col in self.categorical_cols:\n",
    "            if col in df.columns:\n",
    "                # Fill NaN in categoricals with 'Missing' before encoding to be safe\n",
    "                df[col] = df[col].astype(str).fillna('Missing')\n",
    "                df[col] = self.encoders[col].transform(df[[col]]).flatten()\n",
    "\n",
    "        # interaction features\n",
    "        df = self.create_interaction_features(df)\n",
    "        \n",
    "        return df\n",
    "        \n",
    "    def create_interaction_features(self, df):# add because of the Correlation matrix\n",
    "        df = df.copy()\n",
    "        \n",
    "        # sleep_hours * sleep_quality\n",
    "        # assumption : sleep_quality might increase value of sleep_hours\n",
    "        if 'sleep_hours' in df.columns and 'sleep_quality' in df.columns:\n",
    "            df['sleep_hours_quality'] = df['sleep_hours'] * df['sleep_quality']\n",
    "            \n",
    "        # class_attendance * facility_rating\n",
    "        # assumption : better facility_rating with increase the effect class_attendance\n",
    "        if 'class_attendance' in df.columns and 'facility_rating' in df.columns:\n",
    "            df['facility_rating_attendance'] = df['class_attendance'] * df['facility_rating']\n",
    "            \n",
    "        # study_method * study_hours\n",
    "        # study_method might increase value of study_hours\n",
    "        if 'study_method' in df.columns and 'study_hours' in df.columns:\n",
    "            df['study_method_hours'] = df['study_method'] * df['study_hours']\n",
    "        # 2026/01/17 add\n",
    "        # study_hours + class_attendance *0.5\n",
    "        if 'study_hours' in df.columns and 'class_attendance' in df.columns:\n",
    "            df['Total_Effort'] = df['study_hours'] + (df['class_attendance']*0.5)\n",
    "        \n",
    "        return df"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 6,
   "id": "47e27e2a",
   "metadata": {
    "execution": {
     "iopub.execute_input": "2026-01-19T13:55:21.914957Z",
     "iopub.status.busy": "2026-01-19T13:55:21.914721Z",
     "iopub.status.idle": "2026-01-19T13:55:21.917863Z",
     "shell.execute_reply": "2026-01-19T13:55:21.917293Z"
    },
    "papermill": {
     "duration": 0.008368,
     "end_time": "2026-01-19T13:55:21.919370",
     "exception": false,
     "start_time": "2026-01-19T13:55:21.911002",
     "status": "completed"
    },
    "tags": []
   },
   "outputs": [],
   "source": [
    "X_train_raw = train#.drop(columns=['exam_score'])\n",
    "y_train = train['exam_score']"
   ]
  },
  {
   "cell_type": "markdown",
   "id": "f96320ec",
   "metadata": {
    "papermill": {
     "duration": 0.0031,
     "end_time": "2026-01-19T13:55:21.925435",
     "exception": false,
     "start_time": "2026-01-19T13:55:21.922335",
     "status": "completed"
    },
    "tags": []
   },
   "source": [
    "# Train model with Hyper parameter (OPTUNA) \n",
    "\n",
    "2026/01/13 reach TOP 30%\n",
    "1. add optuna for hyperparameter \n",
    "2. cross validation \n",
    "3. combine preprocessor and model into pip line"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 7,
   "id": "c7120ec5",
   "metadata": {
    "execution": {
     "iopub.execute_input": "2026-01-19T13:55:21.932782Z",
     "iopub.status.busy": "2026-01-19T13:55:21.932126Z",
     "iopub.status.idle": "2026-01-19T13:55:21.937807Z",
     "shell.execute_reply": "2026-01-19T13:55:21.937139Z"
    },
    "papermill": {
     "duration": 0.010883,
     "end_time": "2026-01-19T13:55:21.939179",
     "exception": false,
     "start_time": "2026-01-19T13:55:21.928296",
     "status": "completed"
    },
    "tags": []
   },
   "outputs": [],
   "source": [
    "def objective(trial):\n",
    "\n",
    "    model_params = {\n",
    "        \"n_estimators\": trial.suggest_int(\"n_estimators\", 300, 2000),\n",
    "        \"max_depth\": trial.suggest_int(\"max_depth\", 3, 10),\n",
    "        \"learning_rate\": trial.suggest_float(\"learning_rate\", 0.01, 0.2, log=True),\n",
    "        \"subsample\": trial.suggest_float(\"subsample\", 0.5, 1.0),\n",
    "        \"colsample_bytree\": trial.suggest_float(\"colsample_bytree\", 0.5, 1.0),\n",
    "        \"min_child_weight\": trial.suggest_int(\"min_child_weight\", 1, 10),\n",
    "        \"reg_alpha\": trial.suggest_float(\"reg_alpha\", 1e-8, 10.0, log=True),\n",
    "        \"reg_lambda\": trial.suggest_float(\"reg_lambda\", 1e-8, 10.0, log=True),\n",
    "        \"tree_method\": \"hist\", # Faster for large datasets\n",
    "        \"device\": \"cuda\", # If you are using Kaggle GPU\n",
    "    }\n",
    "\n",
    "    pipeline = Pipeline(\n",
    "        steps=[\n",
    "            (\"preprocess\", Preprocessor()),\n",
    "            (\"model\", XGBRegressor(\n",
    "                objective=\"reg:squarederror\",\n",
    "                random_state=CFG.RANDOM_SEED,\n",
    "                n_jobs=-1,\n",
    "                **model_params\n",
    "            ))\n",
    "        ]\n",
    "    )\n",
    "\n",
    "    scores = cross_val_score(\n",
    "        pipeline,\n",
    "        X_train_raw,\n",
    "        y_train,\n",
    "        cv=4,\n",
    "        scoring=\"neg_root_mean_squared_error\",\n",
    "        n_jobs=-1\n",
    "    )\n",
    "\n",
    "    return -scores.mean()"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 8,
   "id": "d81e0cae",
   "metadata": {
    "collapsed": true,
    "execution": {
     "iopub.execute_input": "2026-01-19T13:55:21.945797Z",
     "iopub.status.busy": "2026-01-19T13:55:21.945580Z",
     "iopub.status.idle": "2026-01-19T14:16:35.549195Z",
     "shell.execute_reply": "2026-01-19T14:16:35.548284Z"
    },
    "jupyter": {
     "outputs_hidden": true
    },
    "papermill": {
     "duration": 1273.608773,
     "end_time": "2026-01-19T14:16:35.550738",
     "exception": false,
     "start_time": "2026-01-19T13:55:21.941965",
     "status": "completed"
    },
    "tags": []
   },
   "outputs": [
    {
     "name": "stderr",
     "output_type": "stream",
     "text": [
      "\u001b[32m[I 2026-01-19 13:55:21,947]\u001b[0m A new study created in memory with name: no-name-5297aba9-5d41-4b6f-9399-65dfcf4512c6\u001b[0m\n",
      "/usr/local/lib/python3.12/dist-packages/xgboost/core.py:774: UserWarning: [13:56:28] WARNING: /workspace/src/common/error_msg.cc:41: Falling back to prediction using DMatrix due to mismatched devices. This might lead to higher memory usage and slower performance. XGBoost is running on: cuda:0, while the input data is on: cpu.\n",
      "Potential solutions:\n",
      "- Use a data structure that matches the device ordinal in the booster.\n",
      "- Set the device for booster before call to inplace_predict.\n",
      "\n",
      "This warning will only be shown once.\n",
      "\n",
      "  return func(**kwargs)\n",
      "/usr/local/lib/python3.12/dist-packages/xgboost/core.py:774: UserWarning: [13:56:28] WARNING: /workspace/src/common/error_msg.cc:41: Falling back to prediction using DMatrix due to mismatched devices. This might lead to higher memory usage and slower performance. XGBoost is running on: cuda:0, while the input data is on: cpu.\n",
      "Potential solutions:\n",
      "- Use a data structure that matches the device ordinal in the booster.\n",
      "- Set the device for booster before call to inplace_predict.\n",
      "\n",
      "This warning will only be shown once.\n",
      "\n",
      "  return func(**kwargs)\n",
      "/usr/local/lib/python3.12/dist-packages/xgboost/core.py:774: UserWarning: [13:56:28] WARNING: /workspace/src/common/error_msg.cc:41: Falling back to prediction using DMatrix due to mismatched devices. This might lead to higher memory usage and slower performance. XGBoost is running on: cuda:0, while the input data is on: cpu.\n",
      "Potential solutions:\n",
      "- Use a data structure that matches the device ordinal in the booster.\n",
      "- Set the device for booster before call to inplace_predict.\n",
      "\n",
      "This warning will only be shown once.\n",
      "\n",
      "  return func(**kwargs)\n",
      "/usr/local/lib/python3.12/dist-packages/xgboost/core.py:774: UserWarning: [13:56:28] WARNING: /workspace/src/common/error_msg.cc:41: Falling back to prediction using DMatrix due to mismatched devices. This might lead to higher memory usage and slower performance. XGBoost is running on: cuda:0, while the input data is on: cpu.\n",
      "Potential solutions:\n",
      "- Use a data structure that matches the device ordinal in the booster.\n",
      "- Set the device for booster before call to inplace_predict.\n",
      "\n",
      "This warning will only be shown once.\n",
      "\n",
      "  return func(**kwargs)\n",
      "\u001b[32m[I 2026-01-19 13:56:28,816]\u001b[0m Trial 0 finished with value: 8.951415939477181 and parameters: {'n_estimators': 937, 'max_depth': 10, 'learning_rate': 0.08960785365368121, 'subsample': 0.7993292420985183, 'colsample_bytree': 0.5780093202212182, 'min_child_weight': 2, 'reg_alpha': 3.3323645788192616e-08, 'reg_lambda': 0.6245760287469893}. Best is trial 0 with value: 8.951415939477181.\u001b[0m\n",
      "\u001b[32m[I 2026-01-19 13:57:26,179]\u001b[0m Trial 1 finished with value: 8.773307611524094 and parameters: {'n_estimators': 1322, 'max_depth': 8, 'learning_rate': 0.010636066512540286, 'subsample': 0.9849549260809971, 'colsample_bytree': 0.9162213204002109, 'min_child_weight': 3, 'reg_alpha': 4.329370014459266e-07, 'reg_lambda': 4.4734294104626844e-07}. Best is trial 1 with value: 8.773307611524094.\u001b[0m\n",
      "\u001b[32m[I 2026-01-19 13:57:55,317]\u001b[0m Trial 2 finished with value: 8.763387066932342 and parameters: {'n_estimators': 817, 'max_depth': 7, 'learning_rate': 0.03647316284911211, 'subsample': 0.645614570099021, 'colsample_bytree': 0.8059264473611898, 'min_child_weight': 2, 'reg_alpha': 4.258943089524393e-06, 'reg_lambda': 1.9826980964985924e-05}. Best is trial 2 with value: 8.763387066932342.\u001b[0m\n",
      "\u001b[32m[I 2026-01-19 13:58:54,426]\u001b[0m Trial 3 finished with value: 8.76214522480277 and parameters: {'n_estimators': 1075, 'max_depth': 9, 'learning_rate': 0.018187859051288217, 'subsample': 0.7571172192068059, 'colsample_bytree': 0.7962072844310213, 'min_child_weight': 1, 'reg_alpha': 0.0029369981104377003, 'reg_lambda': 3.425445902633376e-07}. Best is trial 3 with value: 8.76214522480277.\u001b[0m\n",
      "\u001b[32m[I 2026-01-19 13:59:24,582]\u001b[0m Trial 4 finished with value: 9.063016395663414 and parameters: {'n_estimators': 410, 'max_depth': 10, 'learning_rate': 0.18043311207136256, 'subsample': 0.9041986740582306, 'colsample_bytree': 0.6523068845866853, 'min_child_weight': 1, 'reg_alpha': 0.014391207615728067, 'reg_lambda': 9.148975058772307e-05}. Best is trial 3 with value: 8.76214522480277.\u001b[0m\n",
      "\u001b[32m[I 2026-01-19 13:59:42,452]\u001b[0m Trial 5 finished with value: 8.824798808643365 and parameters: {'n_estimators': 507, 'max_depth': 6, 'learning_rate': 0.011085122517311707, 'subsample': 0.954660201039391, 'colsample_bytree': 0.6293899908000085, 'min_child_weight': 7, 'reg_alpha': 6.388511557344611e-06, 'reg_lambda': 0.0004793052550782129}. Best is trial 3 with value: 8.76214522480277.\u001b[0m\n",
      "\u001b[32m[I 2026-01-19 14:00:07,988]\u001b[0m Trial 6 finished with value: 8.767161788197596 and parameters: {'n_estimators': 1229, 'max_depth': 4, 'learning_rate': 0.18258230439200238, 'subsample': 0.8875664116805573, 'colsample_bytree': 0.9697494707820946, 'min_child_weight': 9, 'reg_alpha': 0.002404915432737351, 'reg_lambda': 1.9809253750493907}. Best is trial 3 with value: 8.76214522480277.\u001b[0m\n",
      "\u001b[32m[I 2026-01-19 14:00:20,630]\u001b[0m Trial 7 finished with value: 8.906128376462554 and parameters: {'n_estimators': 450, 'max_depth': 4, 'learning_rate': 0.011450964268326641, 'subsample': 0.6626651653816322, 'colsample_bytree': 0.6943386448447411, 'min_child_weight': 3, 'reg_alpha': 0.28749982347407854, 'reg_lambda': 1.6247252885719427e-05}. Best is trial 3 with value: 8.76214522480277.\u001b[0m\n",
      "\u001b[32m[I 2026-01-19 14:00:49,877]\u001b[0m Trial 8 finished with value: 8.77825411835397 and parameters: {'n_estimators': 777, 'max_depth': 7, 'learning_rate': 0.015252697030515175, 'subsample': 0.9010984903770198, 'colsample_bytree': 0.5372753218398854, 'min_child_weight': 10, 'reg_alpha': 0.08916674715636537, 'reg_lambda': 6.143857495033091e-07}. Best is trial 3 with value: 8.76214522480277.\u001b[0m\n",
      "\u001b[32m[I 2026-01-19 14:01:09,421]\u001b[0m Trial 9 finished with value: 8.79805705653968 and parameters: {'n_estimators': 309, 'max_depth': 9, 'learning_rate': 0.08310795711416077, 'subsample': 0.8645035840204937, 'colsample_bytree': 0.8856351733429728, 'min_child_weight': 1, 'reg_alpha': 1.683416412018213e-05, 'reg_lambda': 1.1036250149900698e-07}. Best is trial 3 with value: 8.76214522480277.\u001b[0m\n",
      "\u001b[32m[I 2026-01-19 14:02:00,685]\u001b[0m Trial 10 finished with value: 8.757362834048276 and parameters: {'n_estimators': 1868, 'max_depth': 6, 'learning_rate': 0.02513734458845406, 'subsample': 0.5089809378074097, 'colsample_bytree': 0.7828065453407016, 'min_child_weight': 5, 'reg_alpha': 4.344469108550388, 'reg_lambda': 1.2784194237583907e-08}. Best is trial 10 with value: 8.757362834048276.\u001b[0m\n",
      "\u001b[32m[I 2026-01-19 14:02:43,739]\u001b[0m Trial 11 finished with value: 8.765328166992887 and parameters: {'n_estimators': 1830, 'max_depth': 5, 'learning_rate': 0.026365703773854398, 'subsample': 0.5085930751344793, 'colsample_bytree': 0.7849598833322474, 'min_child_weight': 5, 'reg_alpha': 7.587120682342015, 'reg_lambda': 1.2536269325652231e-08}. Best is trial 10 with value: 8.757362834048276.\u001b[0m\n",
      "\u001b[32m[I 2026-01-19 14:03:38,364]\u001b[0m Trial 12 finished with value: 8.758282008155305 and parameters: {'n_estimators': 1985, 'max_depth': 6, 'learning_rate': 0.02225171016411916, 'subsample': 0.503283560939651, 'colsample_bytree': 0.8265015800721067, 'min_child_weight': 5, 'reg_alpha': 9.156386757209491, 'reg_lambda': 0.007483948702276161}. Best is trial 10 with value: 8.757362834048276.\u001b[0m\n",
      "\u001b[32m[I 2026-01-19 14:04:32,923]\u001b[0m Trial 13 finished with value: 8.757351247697125 and parameters: {'n_estimators': 1986, 'max_depth': 6, 'learning_rate': 0.028435494649170216, 'subsample': 0.504902872681397, 'colsample_bytree': 0.7242729582256223, 'min_child_weight': 6, 'reg_alpha': 9.868745464853761, 'reg_lambda': 0.016756638283609248}. Best is trial 13 with value: 8.757351247697125.\u001b[0m\n",
      "\u001b[32m[I 2026-01-19 14:05:00,919]\u001b[0m Trial 14 finished with value: 8.789279378803604 and parameters: {'n_estimators': 1598, 'max_depth': 3, 'learning_rate': 0.048612728407273466, 'subsample': 0.5797654491534232, 'colsample_bytree': 0.7210134538072666, 'min_child_weight': 7, 'reg_alpha': 0.6255688317185157, 'reg_lambda': 0.03219086506377499}. Best is trial 13 with value: 8.757351247697125.\u001b[0m\n",
      "\u001b[32m[I 2026-01-19 14:05:39,327]\u001b[0m Trial 15 finished with value: 8.76090227781225 and parameters: {'n_estimators': 1622, 'max_depth': 5, 'learning_rate': 0.03966680020441262, 'subsample': 0.5928650434894713, 'colsample_bytree': 0.730445357055035, 'min_child_weight': 7, 'reg_alpha': 0.00016097275579289827, 'reg_lambda': 0.009745849636897735}. Best is trial 13 with value: 8.757351247697125.\u001b[0m\n",
      "\u001b[32m[I 2026-01-19 14:06:16,648]\u001b[0m Trial 16 finished with value: 8.762583082449936 and parameters: {'n_estimators': 1595, 'max_depth': 5, 'learning_rate': 0.06051256321768739, 'subsample': 0.5646473035492882, 'colsample_bytree': 0.8805304594988682, 'min_child_weight': 6, 'reg_alpha': 1.4318951998429506, 'reg_lambda': 0.10229359002810792}. Best is trial 13 with value: 8.757351247697125.\u001b[0m\n",
      "\u001b[32m[I 2026-01-19 14:07:34,814]\u001b[0m Trial 17 finished with value: 8.771196850925948 and parameters: {'n_estimators': 1986, 'max_depth': 8, 'learning_rate': 0.03050779215869766, 'subsample': 0.6928119354573563, 'colsample_bytree': 0.6553447098489982, 'min_child_weight': 4, 'reg_alpha': 0.040262466210226146, 'reg_lambda': 0.000667954359808675}. Best is trial 13 with value: 8.757351247697125.\u001b[0m\n",
      "\u001b[32m[I 2026-01-19 14:08:24,204]\u001b[0m Trial 18 finished with value: 8.762355272452293 and parameters: {'n_estimators': 1780, 'max_depth': 6, 'learning_rate': 0.01830368667646075, 'subsample': 0.5514679674687517, 'colsample_bytree': 0.745507954486344, 'min_child_weight': 8, 'reg_alpha': 1.7313986699184591, 'reg_lambda': 6.682694832575419}. Best is trial 13 with value: 8.757351247697125.\u001b[0m\n",
      "\u001b[32m[I 2026-01-19 14:08:48,664]\u001b[0m Trial 19 finished with value: 8.791818796513722 and parameters: {'n_estimators': 1386, 'max_depth': 3, 'learning_rate': 0.05618990727743403, 'subsample': 0.6462566899855204, 'colsample_bytree': 0.5976806617545125, 'min_child_weight': 6, 'reg_alpha': 0.0007576681230466948, 'reg_lambda': 0.002240796166722783}. Best is trial 13 with value: 8.757351247697125.\u001b[0m\n",
      "\u001b[32m[I 2026-01-19 14:09:46,578]\u001b[0m Trial 20 finished with value: 8.75785787817714 and parameters: {'n_estimators': 1784, 'max_depth': 7, 'learning_rate': 0.030241420350470272, 'subsample': 0.7136182330812915, 'colsample_bytree': 0.849021899665701, 'min_child_weight': 4, 'reg_alpha': 0.10526316205413053, 'reg_lambda': 3.959627457035505e-06}. Best is trial 13 with value: 8.757351247697125.\u001b[0m\n",
      "\u001b[32m[I 2026-01-19 14:10:45,629]\u001b[0m Trial 21 finished with value: 8.755793984284614 and parameters: {'n_estimators': 1791, 'max_depth': 7, 'learning_rate': 0.029272420392886873, 'subsample': 0.7268267932501222, 'colsample_bytree': 0.8384980369023396, 'min_child_weight': 4, 'reg_alpha': 9.540802369759723, 'reg_lambda': 4.593292927114143e-06}. Best is trial 21 with value: 8.755793984284614.\u001b[0m\n",
      "\u001b[32m[I 2026-01-19 14:11:46,068]\u001b[0m Trial 22 finished with value: 8.759480365755737 and parameters: {'n_estimators': 1462, 'max_depth': 8, 'learning_rate': 0.022595591922071962, 'subsample': 0.8149271154876796, 'colsample_bytree': 0.9750866147991147, 'min_child_weight': 4, 'reg_alpha': 8.174456948613049, 'reg_lambda': 2.1963362887982542e-08}. Best is trial 21 with value: 8.755793984284614.\u001b[0m\n",
      "\u001b[32m[I 2026-01-19 14:12:36,700]\u001b[0m Trial 23 finished with value: 8.757345040998121 and parameters: {'n_estimators': 1846, 'max_depth': 6, 'learning_rate': 0.03559352367252768, 'subsample': 0.6103979188500401, 'colsample_bytree': 0.7748918846675976, 'min_child_weight': 5, 'reg_alpha': 0.7634167976549879, 'reg_lambda': 4.693736686647251e-06}. Best is trial 21 with value: 8.755793984284614.\u001b[0m\n",
      "\u001b[32m[I 2026-01-19 14:13:32,439]\u001b[0m Trial 24 finished with value: 8.819363206102635 and parameters: {'n_estimators': 1686, 'max_depth': 7, 'learning_rate': 0.07401529969557558, 'subsample': 0.6141539070566988, 'colsample_bytree': 0.6932661956409322, 'min_child_weight': 6, 'reg_alpha': 0.3117844227356625, 'reg_lambda': 3.725821313266571e-06}. Best is trial 21 with value: 8.755793984284614.\u001b[0m\n",
      "\u001b[32m[I 2026-01-19 14:14:18,670]\u001b[0m Trial 25 finished with value: 8.757224534579215 and parameters: {'n_estimators': 1999, 'max_depth': 5, 'learning_rate': 0.03533759142022126, 'subsample': 0.7336149243723737, 'colsample_bytree': 0.8477562534349009, 'min_child_weight': 3, 'reg_alpha': 0.9097924854066338, 'reg_lambda': 5.319562007657141e-05}. Best is trial 21 with value: 8.755793984284614.\u001b[0m\n",
      "\u001b[32m[I 2026-01-19 14:14:52,757]\u001b[0m Trial 26 finished with value: 8.76410123474544 and parameters: {'n_estimators': 1709, 'max_depth': 4, 'learning_rate': 0.12077250858915572, 'subsample': 0.745692798800003, 'colsample_bytree': 0.9232072289057628, 'min_child_weight': 3, 'reg_alpha': 0.017380961322626506, 'reg_lambda': 7.138117523739518e-05}. Best is trial 21 with value: 8.755793984284614.\u001b[0m\n",
      "\u001b[32m[I 2026-01-19 14:15:28,396]\u001b[0m Trial 27 finished with value: 8.759068792565518 and parameters: {'n_estimators': 1500, 'max_depth': 5, 'learning_rate': 0.05324761767989167, 'subsample': 0.7886608036150532, 'colsample_bytree': 0.8456187295990553, 'min_child_weight': 4, 'reg_alpha': 1.1145941249206295, 'reg_lambda': 3.144753928188062e-06}. Best is trial 21 with value: 8.755793984284614.\u001b[0m\n",
      "\u001b[32m[I 2026-01-19 14:16:12,403]\u001b[0m Trial 28 finished with value: 8.757706888292734 and parameters: {'n_estimators': 1887, 'max_depth': 5, 'learning_rate': 0.037801528582310076, 'subsample': 0.7177107980119118, 'colsample_bytree': 0.8799767894119798, 'min_child_weight': 2, 'reg_alpha': 0.008929536797745276, 'reg_lambda': 9.212898497411586e-05}. Best is trial 21 with value: 8.755793984284614.\u001b[0m\n",
      "\u001b[32m[I 2026-01-19 14:16:35,545]\u001b[0m Trial 29 finished with value: 8.783532836119434 and parameters: {'n_estimators': 1060, 'max_depth': 4, 'learning_rate': 0.041810196811613964, 'subsample': 0.8238327378242031, 'colsample_bytree': 0.7672585872641438, 'min_child_weight': 2, 'reg_alpha': 0.0001132741666833449, 'reg_lambda': 1.4171389919342518e-05}. Best is trial 21 with value: 8.755793984284614.\u001b[0m\n"
     ]
    }
   ],
   "source": [
    "study = optuna.create_study(\n",
    "    direction=\"minimize\",\n",
    "    sampler=optuna.samplers.TPESampler(seed=CFG.RANDOM_SEED)\n",
    ")\n",
    "\n",
    "# use Optuna to find best parameter\n",
    "study.optimize(objective, n_trials=30)"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 9,
   "id": "a7112425",
   "metadata": {
    "execution": {
     "iopub.execute_input": "2026-01-19T14:16:35.560982Z",
     "iopub.status.busy": "2026-01-19T14:16:35.560701Z",
     "iopub.status.idle": "2026-01-19T14:16:35.565749Z",
     "shell.execute_reply": "2026-01-19T14:16:35.564900Z"
    },
    "papermill": {
     "duration": 0.011768,
     "end_time": "2026-01-19T14:16:35.567217",
     "exception": false,
     "start_time": "2026-01-19T14:16:35.555449",
     "status": "completed"
    },
    "tags": []
   },
   "outputs": [
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "Best RMSE: 8.755793984284614\n",
      "Best params:\n",
      "n_estimators: 1791\n",
      "max_depth: 7\n",
      "learning_rate: 0.029272420392886873\n",
      "subsample: 0.7268267932501222\n",
      "colsample_bytree: 0.8384980369023396\n",
      "min_child_weight: 4\n",
      "reg_alpha: 9.540802369759723\n",
      "reg_lambda: 4.593292927114143e-06\n"
     ]
    }
   ],
   "source": [
    "# 最佳參數\n",
    "print(\"Best RMSE:\", study.best_value)\n",
    "print(\"Best params:\")\n",
    "for k, v in study.best_params.items():\n",
    "    print(f\"{k}: {v}\")"
   ]
  },
  {
   "cell_type": "markdown",
   "id": "4ae3f53a",
   "metadata": {
    "papermill": {
     "duration": 0.004212,
     "end_time": "2026-01-19T14:16:35.576026",
     "exception": false,
     "start_time": "2026-01-19T14:16:35.571814",
     "status": "completed"
    },
    "tags": []
   },
   "source": [
    "# Submission\n",
    "\n",
    "2026/01/19 Out-of-Fold (OOF)"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 10,
   "id": "98137ca2",
   "metadata": {
    "execution": {
     "iopub.execute_input": "2026-01-19T14:16:35.585805Z",
     "iopub.status.busy": "2026-01-19T14:16:35.585583Z",
     "iopub.status.idle": "2026-01-19T14:16:35.588999Z",
     "shell.execute_reply": "2026-01-19T14:16:35.588292Z"
    },
    "papermill": {
     "duration": 0.0102,
     "end_time": "2026-01-19T14:16:35.590457",
     "exception": false,
     "start_time": "2026-01-19T14:16:35.580257",
     "status": "completed"
    },
    "tags": []
   },
   "outputs": [],
   "source": [
    "###########no OOF solution###############\n",
    "#final_pipeline = Pipeline(\n",
    "#    steps=[\n",
    "#        (\"preprocess\", Preprocessor()),\n",
    "#        (\"model\", XGBRegressor(\n",
    "#            **study.best_params,\n",
    "#            objective=\"reg:squarederror\",\n",
    "#            random_state=CFG.RANDOM_SEED,\n",
    "#            n_jobs=-1\n",
    "#        ))\n",
    "#    ]\n",
    "#)\n",
    "\n",
    "#final_pipeline.fit(X_train_raw, y_train)"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 11,
   "id": "71a38d38",
   "metadata": {
    "execution": {
     "iopub.execute_input": "2026-01-19T14:16:35.600399Z",
     "iopub.status.busy": "2026-01-19T14:16:35.600137Z",
     "iopub.status.idle": "2026-01-19T14:16:35.603201Z",
     "shell.execute_reply": "2026-01-19T14:16:35.602679Z"
    },
    "papermill": {
     "duration": 0.009796,
     "end_time": "2026-01-19T14:16:35.604712",
     "exception": false,
     "start_time": "2026-01-19T14:16:35.594916",
     "status": "completed"
    },
    "tags": []
   },
   "outputs": [],
   "source": [
    "#y_pred = final_pipeline.predict(test)\n",
    "\n",
    "#submission = pd.read_csv(CFG.sample_submission_csv)\n",
    "#test_id = test[\"id\"]\n",
    "#submission = pd.DataFrame({\n",
    "#    'Id': test_id, \n",
    "#    'exam_score': y_pred   \n",
    "#})\n",
    "\n",
    "#submission.to_csv('submission.csv', index=False)"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 12,
   "id": "b0c8b5df",
   "metadata": {
    "execution": {
     "iopub.execute_input": "2026-01-19T14:16:35.614440Z",
     "iopub.status.busy": "2026-01-19T14:16:35.614210Z",
     "iopub.status.idle": "2026-01-19T14:16:35.620918Z",
     "shell.execute_reply": "2026-01-19T14:16:35.620254Z"
    },
    "papermill": {
     "duration": 0.013272,
     "end_time": "2026-01-19T14:16:35.622405",
     "exception": false,
     "start_time": "2026-01-19T14:16:35.609133",
     "status": "completed"
    },
    "tags": []
   },
   "outputs": [],
   "source": [
    "def run_cv_and_predict(X, y, test_df, params):\n",
    "    kf = KFold(n_splits=CFG.N_FOLDS, shuffle=True, random_state=CFG.RANDOM_SEED)\n",
    "    \n",
    "    # Storage for OOF and Test predictions\n",
    "    oof_preds = np.zeros(len(X))\n",
    "    test_preds = np.zeros(len(test_df))\n",
    "    scores = []\n",
    "\n",
    "    for fold, (train_idx, val_idx) in enumerate(kf.split(X, y)):\n",
    "        X_train, X_val = X.iloc[train_idx], X.iloc[val_idx]\n",
    "        y_train, y_val = y.iloc[train_idx], y.iloc[val_idx]\n",
    "\n",
    "        # Preprocess inside the fold to prevent leakage\n",
    "        preprocessor = Preprocessor()\n",
    "        X_train_proc = preprocessor.fit_transform(X_train)\n",
    "        X_val_proc = preprocessor.transform(X_val)\n",
    "        X_test_proc = preprocessor.transform(test_df)\n",
    "\n",
    "        # Initialize Model\n",
    "        model = XGBRegressor(**params, random_state=CFG.RANDOM_SEED, n_jobs=-1)\n",
    "\n",
    "        # Fit with Early Stopping\n",
    "        model.fit(\n",
    "            X_train_proc, y_train,\n",
    "            eval_set=[(X_val_proc, y_val)],\n",
    "            verbose=False\n",
    "        )\n",
    "\n",
    "        # Predict\n",
    "        val_preds = model.predict(X_val_proc)\n",
    "        oof_preds[val_idx] = val_preds\n",
    "        test_preds += model.predict(X_test_proc) / CFG.N_FOLDS\n",
    "\n",
    "        # Score the fold\n",
    "        fold_rmse = mean_squared_error(y_val, val_preds)\n",
    "        scores.append(fold_rmse)\n",
    "        print(f\"Fold {fold+1} RMSE: {fold_rmse:.5f}\")\n",
    "\n",
    "    print(f\"\\nOverall CV RMSE: {np.mean(scores):.5f} +/- {np.std(scores):.5f}\")\n",
    "    return oof_preds, test_preds\n"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 13,
   "id": "530e0d29",
   "metadata": {
    "execution": {
     "iopub.execute_input": "2026-01-19T14:16:35.632458Z",
     "iopub.status.busy": "2026-01-19T14:16:35.632192Z",
     "iopub.status.idle": "2026-01-19T14:21:33.544744Z",
     "shell.execute_reply": "2026-01-19T14:21:33.544088Z"
    },
    "papermill": {
     "duration": 297.919746,
     "end_time": "2026-01-19T14:21:33.546740",
     "exception": false,
     "start_time": "2026-01-19T14:16:35.626994",
     "status": "completed"
    },
    "tags": []
   },
   "outputs": [
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "Fold 1 RMSE: 76.40437\n",
      "Fold 2 RMSE: 76.51458\n",
      "Fold 3 RMSE: 76.37320\n",
      "Fold 4 RMSE: 76.69427\n",
      "Fold 5 RMSE: 77.05927\n",
      "\n",
      "Overall CV RMSE: 76.60914 +/- 0.25156\n"
     ]
    }
   ],
   "source": [
    "# run OOF with best parameter\n",
    "best_params = study.best_params\n",
    "oof_train, final_test_preds = run_cv_and_predict(X_train_raw, y_train, test, best_params)\n",
    "\n",
    "# submission\n",
    "submission = pd.DataFrame({\n",
    "    'id': test['id'],\n",
    "    'exam_score': final_test_preds # 這是 5 摺平均後的結果\n",
    "})\n",
    "submission.to_csv('submission.csv', index=False)"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 14,
   "id": "76f250fe",
   "metadata": {
    "execution": {
     "iopub.execute_input": "2026-01-19T14:21:33.557861Z",
     "iopub.status.busy": "2026-01-19T14:21:33.557575Z",
     "iopub.status.idle": "2026-01-19T14:21:33.564686Z",
     "shell.execute_reply": "2026-01-19T14:21:33.564020Z"
    },
    "papermill": {
     "duration": 0.01443,
     "end_time": "2026-01-19T14:21:33.566297",
     "exception": false,
     "start_time": "2026-01-19T14:21:33.551867",
     "status": "completed"
    },
    "tags": []
   },
   "outputs": [
    {
     "data": {
      "text/html": [
       "<div>\n",
       "<style scoped>\n",
       "    .dataframe tbody tr th:only-of-type {\n",
       "        vertical-align: middle;\n",
       "    }\n",
       "\n",
       "    .dataframe tbody tr th {\n",
       "        vertical-align: top;\n",
       "    }\n",
       "\n",
       "    .dataframe thead th {\n",
       "        text-align: right;\n",
       "    }\n",
       "</style>\n",
       "<table border=\"1\" class=\"dataframe\">\n",
       "  <thead>\n",
       "    <tr style=\"text-align: right;\">\n",
       "      <th></th>\n",
       "      <th>id</th>\n",
       "      <th>exam_score</th>\n",
       "    </tr>\n",
       "  </thead>\n",
       "  <tbody>\n",
       "    <tr>\n",
       "      <th>0</th>\n",
       "      <td>630000</td>\n",
       "      <td>71.781084</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>1</th>\n",
       "      <td>630001</td>\n",
       "      <td>70.720030</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>2</th>\n",
       "      <td>630002</td>\n",
       "      <td>87.717228</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>3</th>\n",
       "      <td>630003</td>\n",
       "      <td>55.956739</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>4</th>\n",
       "      <td>630004</td>\n",
       "      <td>47.049323</td>\n",
       "    </tr>\n",
       "  </tbody>\n",
       "</table>\n",
       "</div>"
      ],
      "text/plain": [
       "       id  exam_score\n",
       "0  630000   71.781084\n",
       "1  630001   70.720030\n",
       "2  630002   87.717228\n",
       "3  630003   55.956739\n",
       "4  630004   47.049323"
      ]
     },
     "execution_count": 14,
     "metadata": {},
     "output_type": "execute_result"
    }
   ],
   "source": [
    "submission.head()"
   ]
  }
 ],
 "metadata": {
  "kaggle": {
   "accelerator": "nvidiaTeslaT4",
   "dataSources": [
    {
     "databundleVersionId": 14993753,
     "sourceId": 119082,
     "sourceType": "competition"
    }
   ],
   "dockerImageVersionId": 31234,
   "isGpuEnabled": true,
   "isInternetEnabled": true,
   "language": "python",
   "sourceType": "notebook"
  },
  "kernelspec": {
   "display_name": "Python 3",
   "language": "python",
   "name": "python3"
  },
  "language_info": {
   "codemirror_mode": {
    "name": "ipython",
    "version": 3
   },
   "file_extension": ".py",
   "mimetype": "text/x-python",
   "name": "python",
   "nbconvert_exporter": "python",
   "pygments_lexer": "ipython3",
   "version": "3.12.12"
  },
  "papermill": {
   "default_parameters": {},
   "duration": 1593.75512,
   "end_time": "2026-01-19T14:21:36.289716",
   "environment_variables": {},
   "exception": null,
   "input_path": "__notebook__.ipynb",
   "output_path": "__notebook__.ipynb",
   "parameters": {},
   "start_time": "2026-01-19T13:55:02.534596",
   "version": "2.6.0"
  }
 },
 "nbformat": 4,
 "nbformat_minor": 5
}
