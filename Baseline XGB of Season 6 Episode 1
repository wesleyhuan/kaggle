{
 "cells": [
  {
   "cell_type": "markdown",
   "id": "458817fb",
   "metadata": {
    "papermill": {
     "duration": 0.003435,
     "end_time": "2026-01-21T13:13:35.321954",
     "exception": false,
     "start_time": "2026-01-21T13:13:35.318519",
     "status": "completed"
    },
    "tags": []
   },
   "source": [
    "# Outline\n",
    "\n",
    "This notebook include model training process and with optuna hyperparameter finding.\n",
    "\n",
    "Preprocess and feature Engineering is base on previous notebook.\n",
    "\n",
    "link : [https://www.kaggle.com/code/wesleyhuan/beginer-level-eda-season-6-episode-1](http://)\n",
    "\n",
    "Include these steps:\n",
    "\n",
    "* Load data\n",
    "* Preprocess data\n",
    "* Train model with Hyper parameter (OPTUNA)\n",
    "* Submission"
   ]
  },
  {
   "cell_type": "markdown",
   "id": "c2a48856",
   "metadata": {
    "papermill": {
     "duration": 0.002498,
     "end_time": "2026-01-21T13:13:35.327144",
     "exception": false,
     "start_time": "2026-01-21T13:13:35.324646",
     "status": "completed"
    },
    "tags": []
   },
   "source": [
    "# Load data"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 1,
   "id": "ec0f54be",
   "metadata": {
    "execution": {
     "iopub.execute_input": "2026-01-21T13:13:35.333242Z",
     "iopub.status.busy": "2026-01-21T13:13:35.333008Z",
     "iopub.status.idle": "2026-01-21T13:13:44.936940Z",
     "shell.execute_reply": "2026-01-21T13:13:44.936175Z"
    },
    "papermill": {
     "duration": 9.608901,
     "end_time": "2026-01-21T13:13:44.938636",
     "exception": false,
     "start_time": "2026-01-21T13:13:35.329735",
     "status": "completed"
    },
    "tags": []
   },
   "outputs": [
    {
     "name": "stderr",
     "output_type": "stream",
     "text": [
      "/usr/local/lib/python3.12/dist-packages/sqlalchemy/orm/query.py:195: SyntaxWarning: \"is not\" with 'tuple' literal. Did you mean \"!=\"?\n",
      "  if entities is not ():\n"
     ]
    }
   ],
   "source": [
    "# import necessary library\n",
    "import numpy as np # linear algebra\n",
    "import pandas as pd # data processing, CSV file I/O (e.g. pd.read_csv)\n",
    "import matplotlib.pyplot as plt\n",
    "import seaborn as sns\n",
    "\n",
    "from sklearn.preprocessing import OrdinalEncoder,LabelEncoder\n",
    "\n",
    "from xgboost import XGBRegressor\n",
    "from sklearn.metrics import mean_squared_error\n",
    "from sklearn.model_selection import train_test_split\n",
    "\n",
    "#for optuna pipline\n",
    "import optuna\n",
    "from sklearn.pipeline import Pipeline\n",
    "from sklearn.model_selection import KFold, cross_val_score\n",
    "from sklearn.base import BaseEstimator, TransformerMixin\n",
    "import torch"
   ]
  },
  {
   "cell_type": "markdown",
   "id": "61d92d5d",
   "metadata": {
    "papermill": {
     "duration": 0.002731,
     "end_time": "2026-01-21T13:13:44.944364",
     "exception": false,
     "start_time": "2026-01-21T13:13:44.941633",
     "status": "completed"
    },
    "tags": []
   },
   "source": [
    "# Load data"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 2,
   "id": "c3834716",
   "metadata": {
    "execution": {
     "iopub.execute_input": "2026-01-21T13:13:44.950725Z",
     "iopub.status.busy": "2026-01-21T13:13:44.950295Z",
     "iopub.status.idle": "2026-01-21T13:13:45.031373Z",
     "shell.execute_reply": "2026-01-21T13:13:45.030642Z"
    },
    "papermill": {
     "duration": 0.085917,
     "end_time": "2026-01-21T13:13:45.032847",
     "exception": false,
     "start_time": "2026-01-21T13:13:44.946930",
     "status": "completed"
    },
    "tags": []
   },
   "outputs": [
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "now using cuda\n"
     ]
    }
   ],
   "source": [
    "# config\n",
    "class CFG:\n",
    "    train_csv = '/kaggle/input/playground-series-s6e1/train.csv'\n",
    "    test_csv = '/kaggle/input/playground-series-s6e1/test.csv'\n",
    "    sample_submission_csv = '/kaggle/input/playground-series-s6e1/sample_submission.csv'\n",
    "    N_FOLDS = 5\n",
    "    RANDOM_SEED = 42\n",
    "    \n",
    "#torch.device('cuda' if torch.cuda.is_available() else 'cpu')\n",
    "device = 'cuda' if torch.cuda.is_available() else 'cpu'\n",
    "print(f\"now using {device}\")"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 3,
   "id": "4220bf30",
   "metadata": {
    "execution": {
     "iopub.execute_input": "2026-01-21T13:13:45.039717Z",
     "iopub.status.busy": "2026-01-21T13:13:45.039044Z",
     "iopub.status.idle": "2026-01-21T13:13:46.431882Z",
     "shell.execute_reply": "2026-01-21T13:13:46.431050Z"
    },
    "papermill": {
     "duration": 1.39796,
     "end_time": "2026-01-21T13:13:46.433608",
     "exception": false,
     "start_time": "2026-01-21T13:13:45.035648",
     "status": "completed"
    },
    "tags": []
   },
   "outputs": [],
   "source": [
    "train = pd.read_csv(CFG.train_csv)\n",
    "test = pd.read_csv(CFG.test_csv)"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 4,
   "id": "47f40764",
   "metadata": {
    "execution": {
     "iopub.execute_input": "2026-01-21T13:13:46.440506Z",
     "iopub.status.busy": "2026-01-21T13:13:46.440054Z",
     "iopub.status.idle": "2026-01-21T13:13:46.465255Z",
     "shell.execute_reply": "2026-01-21T13:13:46.464658Z"
    },
    "papermill": {
     "duration": 0.030099,
     "end_time": "2026-01-21T13:13:46.466588",
     "exception": false,
     "start_time": "2026-01-21T13:13:46.436489",
     "status": "completed"
    },
    "tags": []
   },
   "outputs": [
    {
     "data": {
      "text/html": [
       "<div>\n",
       "<style scoped>\n",
       "    .dataframe tbody tr th:only-of-type {\n",
       "        vertical-align: middle;\n",
       "    }\n",
       "\n",
       "    .dataframe tbody tr th {\n",
       "        vertical-align: top;\n",
       "    }\n",
       "\n",
       "    .dataframe thead th {\n",
       "        text-align: right;\n",
       "    }\n",
       "</style>\n",
       "<table border=\"1\" class=\"dataframe\">\n",
       "  <thead>\n",
       "    <tr style=\"text-align: right;\">\n",
       "      <th></th>\n",
       "      <th>id</th>\n",
       "      <th>age</th>\n",
       "      <th>gender</th>\n",
       "      <th>course</th>\n",
       "      <th>study_hours</th>\n",
       "      <th>class_attendance</th>\n",
       "      <th>internet_access</th>\n",
       "      <th>sleep_hours</th>\n",
       "      <th>sleep_quality</th>\n",
       "      <th>study_method</th>\n",
       "      <th>facility_rating</th>\n",
       "      <th>exam_difficulty</th>\n",
       "    </tr>\n",
       "  </thead>\n",
       "  <tbody>\n",
       "    <tr>\n",
       "      <th>0</th>\n",
       "      <td>630000</td>\n",
       "      <td>24</td>\n",
       "      <td>other</td>\n",
       "      <td>ba</td>\n",
       "      <td>6.85</td>\n",
       "      <td>65.2</td>\n",
       "      <td>yes</td>\n",
       "      <td>5.2</td>\n",
       "      <td>poor</td>\n",
       "      <td>group study</td>\n",
       "      <td>high</td>\n",
       "      <td>easy</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>1</th>\n",
       "      <td>630001</td>\n",
       "      <td>18</td>\n",
       "      <td>male</td>\n",
       "      <td>diploma</td>\n",
       "      <td>6.61</td>\n",
       "      <td>45.0</td>\n",
       "      <td>no</td>\n",
       "      <td>9.3</td>\n",
       "      <td>poor</td>\n",
       "      <td>coaching</td>\n",
       "      <td>low</td>\n",
       "      <td>easy</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>2</th>\n",
       "      <td>630002</td>\n",
       "      <td>24</td>\n",
       "      <td>female</td>\n",
       "      <td>b.tech</td>\n",
       "      <td>6.60</td>\n",
       "      <td>98.5</td>\n",
       "      <td>yes</td>\n",
       "      <td>6.2</td>\n",
       "      <td>good</td>\n",
       "      <td>group study</td>\n",
       "      <td>medium</td>\n",
       "      <td>moderate</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>3</th>\n",
       "      <td>630003</td>\n",
       "      <td>24</td>\n",
       "      <td>male</td>\n",
       "      <td>diploma</td>\n",
       "      <td>3.03</td>\n",
       "      <td>66.3</td>\n",
       "      <td>yes</td>\n",
       "      <td>5.7</td>\n",
       "      <td>average</td>\n",
       "      <td>mixed</td>\n",
       "      <td>medium</td>\n",
       "      <td>moderate</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>4</th>\n",
       "      <td>630004</td>\n",
       "      <td>20</td>\n",
       "      <td>female</td>\n",
       "      <td>b.tech</td>\n",
       "      <td>2.03</td>\n",
       "      <td>42.4</td>\n",
       "      <td>yes</td>\n",
       "      <td>9.2</td>\n",
       "      <td>average</td>\n",
       "      <td>coaching</td>\n",
       "      <td>low</td>\n",
       "      <td>moderate</td>\n",
       "    </tr>\n",
       "  </tbody>\n",
       "</table>\n",
       "</div>"
      ],
      "text/plain": [
       "       id  age  gender   course  study_hours  class_attendance  \\\n",
       "0  630000   24   other       ba         6.85              65.2   \n",
       "1  630001   18    male  diploma         6.61              45.0   \n",
       "2  630002   24  female   b.tech         6.60              98.5   \n",
       "3  630003   24    male  diploma         3.03              66.3   \n",
       "4  630004   20  female   b.tech         2.03              42.4   \n",
       "\n",
       "  internet_access  sleep_hours sleep_quality study_method facility_rating  \\\n",
       "0             yes          5.2          poor  group study            high   \n",
       "1              no          9.3          poor     coaching             low   \n",
       "2             yes          6.2          good  group study          medium   \n",
       "3             yes          5.7       average        mixed          medium   \n",
       "4             yes          9.2       average     coaching             low   \n",
       "\n",
       "  exam_difficulty  \n",
       "0            easy  \n",
       "1            easy  \n",
       "2        moderate  \n",
       "3        moderate  \n",
       "4        moderate  "
      ]
     },
     "execution_count": 4,
     "metadata": {},
     "output_type": "execute_result"
    }
   ],
   "source": [
    "test.head()"
   ]
  },
  {
   "cell_type": "markdown",
   "id": "0a1ada84",
   "metadata": {
    "papermill": {
     "duration": 0.00285,
     "end_time": "2026-01-21T13:13:46.472471",
     "exception": false,
     "start_time": "2026-01-21T13:13:46.469621",
     "status": "completed"
    },
    "tags": []
   },
   "source": [
    "# Preprocess data\n",
    "\n",
    "2026/01/13\n",
    "change into class for pipline"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 5,
   "id": "05ccb214",
   "metadata": {
    "execution": {
     "iopub.execute_input": "2026-01-21T13:13:46.479202Z",
     "iopub.status.busy": "2026-01-21T13:13:46.478970Z",
     "iopub.status.idle": "2026-01-21T13:13:46.489566Z",
     "shell.execute_reply": "2026-01-21T13:13:46.489008Z"
    },
    "papermill": {
     "duration": 0.015557,
     "end_time": "2026-01-21T13:13:46.490782",
     "exception": false,
     "start_time": "2026-01-21T13:13:46.475225",
     "status": "completed"
    },
    "tags": []
   },
   "outputs": [],
   "source": [
    "class Preprocessor(BaseEstimator, TransformerMixin):\n",
    "    def __init__(self):\n",
    "        self.medians = {}\n",
    "        self.encoders = {}\n",
    "        self.numeric_cols = []\n",
    "        self.all_non_numeric = []\n",
    "        self.categorical_cols = []\n",
    "        self.level_mapping = {'easy': 1, 'moderate': 2, 'hard': 3,\n",
    "                              'low': 1, 'medium': 2, 'high': 3,\n",
    "                              'poor': 1, 'average': 2, 'good': 3}\n",
    "        self.level_cols = ['sleep_quality', 'facility_rating', 'exam_difficulty']\n",
    "        \n",
    "    def fit(self, df, y=None):\n",
    "        \"\"\"\n",
    "        Learn the parameters (medians, categories) from the TRAINING data.\n",
    "        \"\"\"\n",
    "        # Identify columns\n",
    "        self.numeric_cols = df.select_dtypes(include=[np.number]).columns.tolist()\n",
    "        self.all_non_numeric = df.select_dtypes(exclude=[np.number]).columns.tolist()\n",
    "        self.categorical_cols = [c for c in self.all_non_numeric if c not in self.level_cols]\n",
    "        \n",
    "        # Learn Medians for numeric columns\n",
    "        for col in self.numeric_cols:\n",
    "            self.medians[col] = df[col].median()\n",
    "            \n",
    "        # Fit Encoders for categorical columns\n",
    "        # handle_unknown='use_encoded_value' prevents crashes if Test data has new categories\n",
    "        for col in self.categorical_cols:\n",
    "            enc = OrdinalEncoder(handle_unknown='use_encoded_value', unknown_value=-1)\n",
    "            enc.fit(df[[col]].astype(str)) \n",
    "            self.encoders[col] = enc\n",
    "            \n",
    "        return self\n",
    "\n",
    "    def transform(self, df):\n",
    "        \"\"\"\n",
    "        Apply the learned parameters to the data (Train or Test).\n",
    "        \"\"\"\n",
    "        df = df.copy()\n",
    "        \n",
    "        # Drop irrelevant columns (ID is usually dropped, Target handled separately)\n",
    "        # Note: We don't drop target here to keep X and y aligned until the end\n",
    "        cols_to_drop = ['id', 'exam_score']\n",
    "        df = df.drop(columns=[c for c in cols_to_drop if c in df.columns])\n",
    "\n",
    "        # level encoding\n",
    "        for col in self.level_cols:\n",
    "            if col in df.columns:\n",
    "                # ues mapping rule fillna with 0 \n",
    "                df[col] = df[col].map(self.level_mapping).fillna(0).astype(int)\n",
    "        # Impute Missing Values using LEARNED medians\n",
    "        for col in self.numeric_cols:\n",
    "            if col in df.columns:\n",
    "                df[col] = df[col].fillna(self.medians.get(col, 0))\n",
    "        \n",
    "        # Apply Encoding\n",
    "        for col in self.categorical_cols:\n",
    "            if col in df.columns:\n",
    "                # Fill NaN in categoricals with 'Missing' before encoding to be safe\n",
    "                df[col] = df[col].astype(str).fillna('Missing')\n",
    "                df[col] = self.encoders[col].transform(df[[col]]).flatten()\n",
    "\n",
    "        # interaction features\n",
    "        df = self.create_interaction_features(df)\n",
    "        \n",
    "        return df\n",
    "        \n",
    "    def create_interaction_features(self, df):# add because of the Correlation matrix\n",
    "        df = df.copy()\n",
    "        \n",
    "        # sleep_hours * sleep_quality\n",
    "        # assumption : sleep_quality might increase value of sleep_hours\n",
    "        if 'sleep_hours' in df.columns and 'sleep_quality' in df.columns:\n",
    "            df['sleep_hours_quality'] = df['sleep_hours'] * df['sleep_quality']\n",
    "            \n",
    "        # class_attendance * facility_rating\n",
    "        # assumption : better facility_rating with increase the effect class_attendance\n",
    "        if 'class_attendance' in df.columns and 'facility_rating' in df.columns:\n",
    "            df['facility_rating_attendance'] = df['class_attendance'] * df['facility_rating']\n",
    "            \n",
    "        # study_method * study_hours\n",
    "        # study_method might increase value of study_hours\n",
    "        if 'study_method' in df.columns and 'study_hours' in df.columns:\n",
    "            df['study_method_hours'] = df['study_method'] * df['study_hours']\n",
    "        # 2026/01/17 add\n",
    "        # study_hours + class_attendance *0.5\n",
    "        if 'study_hours' in df.columns and 'class_attendance' in df.columns:\n",
    "            df['Total_Effort'] = df['study_hours'] + (df['class_attendance']*0.5)\n",
    "        \n",
    "        return df"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 6,
   "id": "7c1e8808",
   "metadata": {
    "execution": {
     "iopub.execute_input": "2026-01-21T13:13:46.497186Z",
     "iopub.status.busy": "2026-01-21T13:13:46.496968Z",
     "iopub.status.idle": "2026-01-21T13:13:46.500275Z",
     "shell.execute_reply": "2026-01-21T13:13:46.499692Z"
    },
    "papermill": {
     "duration": 0.008017,
     "end_time": "2026-01-21T13:13:46.501598",
     "exception": false,
     "start_time": "2026-01-21T13:13:46.493581",
     "status": "completed"
    },
    "tags": []
   },
   "outputs": [],
   "source": [
    "X_train_raw = train#.drop(columns=['exam_score'])\n",
    "y_train = train['exam_score']"
   ]
  },
  {
   "cell_type": "markdown",
   "id": "c1ec5b73",
   "metadata": {
    "papermill": {
     "duration": 0.002738,
     "end_time": "2026-01-21T13:13:46.507101",
     "exception": false,
     "start_time": "2026-01-21T13:13:46.504363",
     "status": "completed"
    },
    "tags": []
   },
   "source": [
    "# Train model with Hyper parameter (OPTUNA) \n",
    "\n",
    "2026/01/13 reach TOP 30%\n",
    "1. add optuna for hyperparameter \n",
    "2. cross validation \n",
    "3. combine preprocessor and model into pip line"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 7,
   "id": "29fb50ee",
   "metadata": {
    "execution": {
     "iopub.execute_input": "2026-01-21T13:13:46.513932Z",
     "iopub.status.busy": "2026-01-21T13:13:46.513408Z",
     "iopub.status.idle": "2026-01-21T13:13:46.518699Z",
     "shell.execute_reply": "2026-01-21T13:13:46.518132Z"
    },
    "papermill": {
     "duration": 0.009938,
     "end_time": "2026-01-21T13:13:46.519905",
     "exception": false,
     "start_time": "2026-01-21T13:13:46.509967",
     "status": "completed"
    },
    "tags": []
   },
   "outputs": [],
   "source": [
    "def objective(trial):\n",
    "\n",
    "    model_params = {\n",
    "        \"n_estimators\": trial.suggest_int(\"n_estimators\", 300, 2000),\n",
    "        \"max_depth\": trial.suggest_int(\"max_depth\", 3, 10),\n",
    "        \"learning_rate\": trial.suggest_float(\"learning_rate\", 0.01, 0.2, log=True),\n",
    "        \"subsample\": trial.suggest_float(\"subsample\", 0.5, 1.0),\n",
    "        \"colsample_bytree\": trial.suggest_float(\"colsample_bytree\", 0.5, 1.0),\n",
    "        \"min_child_weight\": trial.suggest_int(\"min_child_weight\", 1, 10),\n",
    "        \"reg_alpha\": trial.suggest_float(\"reg_alpha\", 1e-8, 10.0, log=True),\n",
    "        \"reg_lambda\": trial.suggest_float(\"reg_lambda\", 1e-8, 10.0, log=True),\n",
    "        \"tree_method\": \"hist\", # Faster for large datasets\n",
    "        \"device\": \"cuda\", # If you are using Kaggle GPU\n",
    "    }\n",
    "\n",
    "    pipeline = Pipeline(\n",
    "        steps=[\n",
    "            (\"preprocess\", Preprocessor()),\n",
    "            (\"model\", XGBRegressor(\n",
    "                objective=\"reg:squarederror\",\n",
    "                random_state=CFG.RANDOM_SEED,\n",
    "                n_jobs=-1,\n",
    "                **model_params\n",
    "            ))\n",
    "        ]\n",
    "    )\n",
    "\n",
    "    scores = cross_val_score(\n",
    "        pipeline,\n",
    "        X_train_raw,\n",
    "        y_train,\n",
    "        cv=CFG.N_FOLDS,\n",
    "        scoring=\"neg_root_mean_squared_error\",\n",
    "        n_jobs=-1\n",
    "    )\n",
    "\n",
    "    return -scores.mean()"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 8,
   "id": "4d4547bd",
   "metadata": {
    "execution": {
     "iopub.execute_input": "2026-01-21T13:13:46.526502Z",
     "iopub.status.busy": "2026-01-21T13:13:46.526063Z",
     "iopub.status.idle": "2026-01-21T13:46:18.355163Z",
     "shell.execute_reply": "2026-01-21T13:46:18.354568Z"
    },
    "papermill": {
     "duration": 1951.838482,
     "end_time": "2026-01-21T13:46:18.361159",
     "exception": false,
     "start_time": "2026-01-21T13:13:46.522677",
     "status": "completed"
    },
    "tags": []
   },
   "outputs": [
    {
     "name": "stderr",
     "output_type": "stream",
     "text": [
      "\u001b[32m[I 2026-01-21 13:13:46,527]\u001b[0m A new study created in memory with name: no-name-2e412842-14a6-4935-ab71-24f904517137\u001b[0m\n",
      "/usr/local/lib/python3.12/dist-packages/xgboost/core.py:774: UserWarning: [13:14:53] WARNING: /workspace/src/common/error_msg.cc:41: Falling back to prediction using DMatrix due to mismatched devices. This might lead to higher memory usage and slower performance. XGBoost is running on: cuda:0, while the input data is on: cpu.\n",
      "Potential solutions:\n",
      "- Use a data structure that matches the device ordinal in the booster.\n",
      "- Set the device for booster before call to inplace_predict.\n",
      "\n",
      "This warning will only be shown once.\n",
      "\n",
      "  return func(**kwargs)\n",
      "/usr/local/lib/python3.12/dist-packages/xgboost/core.py:774: UserWarning: [13:14:53] WARNING: /workspace/src/common/error_msg.cc:41: Falling back to prediction using DMatrix due to mismatched devices. This might lead to higher memory usage and slower performance. XGBoost is running on: cuda:0, while the input data is on: cpu.\n",
      "Potential solutions:\n",
      "- Use a data structure that matches the device ordinal in the booster.\n",
      "- Set the device for booster before call to inplace_predict.\n",
      "\n",
      "This warning will only be shown once.\n",
      "\n",
      "  return func(**kwargs)\n",
      "/usr/local/lib/python3.12/dist-packages/xgboost/core.py:774: UserWarning: [13:14:53] WARNING: /workspace/src/common/error_msg.cc:41: Falling back to prediction using DMatrix due to mismatched devices. This might lead to higher memory usage and slower performance. XGBoost is running on: cuda:0, while the input data is on: cpu.\n",
      "Potential solutions:\n",
      "- Use a data structure that matches the device ordinal in the booster.\n",
      "- Set the device for booster before call to inplace_predict.\n",
      "\n",
      "This warning will only be shown once.\n",
      "\n",
      "  return func(**kwargs)\n",
      "/usr/local/lib/python3.12/dist-packages/xgboost/core.py:774: UserWarning: [13:14:53] WARNING: /workspace/src/common/error_msg.cc:41: Falling back to prediction using DMatrix due to mismatched devices. This might lead to higher memory usage and slower performance. XGBoost is running on: cuda:0, while the input data is on: cpu.\n",
      "Potential solutions:\n",
      "- Use a data structure that matches the device ordinal in the booster.\n",
      "- Set the device for booster before call to inplace_predict.\n",
      "\n",
      "This warning will only be shown once.\n",
      "\n",
      "  return func(**kwargs)\n",
      "\u001b[32m[I 2026-01-21 13:15:07,952]\u001b[0m Trial 0 finished with value: 8.93620269801541 and parameters: {'n_estimators': 937, 'max_depth': 10, 'learning_rate': 0.08960785365368121, 'subsample': 0.7993292420985183, 'colsample_bytree': 0.5780093202212182, 'min_child_weight': 2, 'reg_alpha': 3.3323645788192616e-08, 'reg_lambda': 0.6245760287469893}. Best is trial 0 with value: 8.93620269801541.\u001b[0m\n",
      "\u001b[32m[I 2026-01-21 13:16:17,961]\u001b[0m Trial 1 finished with value: 8.770638099775912 and parameters: {'n_estimators': 1322, 'max_depth': 8, 'learning_rate': 0.010636066512540286, 'subsample': 0.9849549260809971, 'colsample_bytree': 0.9162213204002109, 'min_child_weight': 3, 'reg_alpha': 4.329370014459266e-07, 'reg_lambda': 4.4734294104626844e-07}. Best is trial 1 with value: 8.770638099775912.\u001b[0m\n",
      "\u001b[32m[I 2026-01-21 13:16:53,472]\u001b[0m Trial 2 finished with value: 8.76232847647799 and parameters: {'n_estimators': 817, 'max_depth': 7, 'learning_rate': 0.03647316284911211, 'subsample': 0.645614570099021, 'colsample_bytree': 0.8059264473611898, 'min_child_weight': 2, 'reg_alpha': 4.258943089524393e-06, 'reg_lambda': 1.9826980964985924e-05}. Best is trial 2 with value: 8.76232847647799.\u001b[0m\n",
      "\u001b[32m[I 2026-01-21 13:18:05,956]\u001b[0m Trial 3 finished with value: 8.758812150338716 and parameters: {'n_estimators': 1075, 'max_depth': 9, 'learning_rate': 0.018187859051288217, 'subsample': 0.7571172192068059, 'colsample_bytree': 0.7962072844310213, 'min_child_weight': 1, 'reg_alpha': 0.0029369981104377003, 'reg_lambda': 3.425445902633376e-07}. Best is trial 3 with value: 8.758812150338716.\u001b[0m\n",
      "\u001b[32m[I 2026-01-21 13:18:43,901]\u001b[0m Trial 4 finished with value: 9.03826244388407 and parameters: {'n_estimators': 410, 'max_depth': 10, 'learning_rate': 0.18043311207136256, 'subsample': 0.9041986740582306, 'colsample_bytree': 0.6523068845866853, 'min_child_weight': 1, 'reg_alpha': 0.014391207615728067, 'reg_lambda': 9.148975058772307e-05}. Best is trial 3 with value: 8.758812150338716.\u001b[0m\n",
      "\u001b[32m[I 2026-01-21 13:19:05,873]\u001b[0m Trial 5 finished with value: 8.82444544484457 and parameters: {'n_estimators': 507, 'max_depth': 6, 'learning_rate': 0.011085122517311707, 'subsample': 0.954660201039391, 'colsample_bytree': 0.6293899908000085, 'min_child_weight': 7, 'reg_alpha': 6.388511557344611e-06, 'reg_lambda': 0.0004793052550782129}. Best is trial 3 with value: 8.758812150338716.\u001b[0m\n",
      "\u001b[32m[I 2026-01-21 13:19:35,983]\u001b[0m Trial 6 finished with value: 8.762264931530147 and parameters: {'n_estimators': 1229, 'max_depth': 4, 'learning_rate': 0.18258230439200238, 'subsample': 0.8875664116805573, 'colsample_bytree': 0.9697494707820946, 'min_child_weight': 9, 'reg_alpha': 0.002404915432737351, 'reg_lambda': 1.9809253750493907}. Best is trial 3 with value: 8.758812150338716.\u001b[0m\n",
      "\u001b[32m[I 2026-01-21 13:19:51,477]\u001b[0m Trial 7 finished with value: 8.905184453723566 and parameters: {'n_estimators': 450, 'max_depth': 4, 'learning_rate': 0.011450964268326641, 'subsample': 0.6626651653816322, 'colsample_bytree': 0.6943386448447411, 'min_child_weight': 3, 'reg_alpha': 0.28749982347407854, 'reg_lambda': 1.6247252885719427e-05}. Best is trial 3 with value: 8.758812150338716.\u001b[0m\n",
      "\u001b[32m[I 2026-01-21 13:20:27,197]\u001b[0m Trial 8 finished with value: 8.776519447592507 and parameters: {'n_estimators': 777, 'max_depth': 7, 'learning_rate': 0.015252697030515175, 'subsample': 0.9010984903770198, 'colsample_bytree': 0.5372753218398854, 'min_child_weight': 10, 'reg_alpha': 0.08916674715636537, 'reg_lambda': 6.143857495033091e-07}. Best is trial 3 with value: 8.758812150338716.\u001b[0m\n",
      "\u001b[32m[I 2026-01-21 13:20:51,858]\u001b[0m Trial 9 finished with value: 8.791921455168607 and parameters: {'n_estimators': 309, 'max_depth': 9, 'learning_rate': 0.08310795711416077, 'subsample': 0.8645035840204937, 'colsample_bytree': 0.8856351733429728, 'min_child_weight': 1, 'reg_alpha': 1.683416412018213e-05, 'reg_lambda': 1.1036250149900698e-07}. Best is trial 3 with value: 8.758812150338716.\u001b[0m\n",
      "\u001b[32m[I 2026-01-21 13:21:53,294]\u001b[0m Trial 10 finished with value: 8.755762103384479 and parameters: {'n_estimators': 1868, 'max_depth': 6, 'learning_rate': 0.02513734458845406, 'subsample': 0.5089809378074097, 'colsample_bytree': 0.7828065453407016, 'min_child_weight': 5, 'reg_alpha': 4.344469108550388, 'reg_lambda': 1.2784194237583907e-08}. Best is trial 10 with value: 8.755762103384479.\u001b[0m\n",
      "\u001b[32m[I 2026-01-21 13:22:44,106]\u001b[0m Trial 11 finished with value: 8.763602293450528 and parameters: {'n_estimators': 1830, 'max_depth': 5, 'learning_rate': 0.026365703773854398, 'subsample': 0.5085930751344793, 'colsample_bytree': 0.7849598833322474, 'min_child_weight': 5, 'reg_alpha': 7.587120682342015, 'reg_lambda': 1.2536269325652231e-08}. Best is trial 10 with value: 8.755762103384479.\u001b[0m\n",
      "\u001b[32m[I 2026-01-21 13:23:48,214]\u001b[0m Trial 12 finished with value: 8.755730127693019 and parameters: {'n_estimators': 1985, 'max_depth': 6, 'learning_rate': 0.02225171016411916, 'subsample': 0.503283560939651, 'colsample_bytree': 0.8265015800721067, 'min_child_weight': 5, 'reg_alpha': 9.156386757209491, 'reg_lambda': 0.007483948702276161}. Best is trial 12 with value: 8.755730127693019.\u001b[0m\n",
      "\u001b[32m[I 2026-01-21 13:24:52,395]\u001b[0m Trial 13 finished with value: 8.753994875578913 and parameters: {'n_estimators': 1986, 'max_depth': 6, 'learning_rate': 0.028435494649170216, 'subsample': 0.504902872681397, 'colsample_bytree': 0.7242729582256223, 'min_child_weight': 6, 'reg_alpha': 9.868745464853761, 'reg_lambda': 0.016756638283609248}. Best is trial 13 with value: 8.753994875578913.\u001b[0m\n",
      "\u001b[32m[I 2026-01-21 13:25:23,917]\u001b[0m Trial 14 finished with value: 8.790821890212426 and parameters: {'n_estimators': 1587, 'max_depth': 3, 'learning_rate': 0.044332580107209384, 'subsample': 0.5874188622287926, 'colsample_bytree': 0.7142386048520458, 'min_child_weight': 7, 'reg_alpha': 0.6074782243615471, 'reg_lambda': 0.015758067941701443}. Best is trial 13 with value: 8.753994875578913.\u001b[0m\n",
      "\u001b[32m[I 2026-01-21 13:26:18,606]\u001b[0m Trial 15 finished with value: 8.758646762959174 and parameters: {'n_estimators': 2000, 'max_depth': 5, 'learning_rate': 0.0636206219785753, 'subsample': 0.5840842709170048, 'colsample_bytree': 0.8620313930247292, 'min_child_weight': 7, 'reg_alpha': 9.45037842436589, 'reg_lambda': 0.019356204030329876}. Best is trial 13 with value: 8.753994875578913.\u001b[0m\n",
      "\u001b[32m[I 2026-01-21 13:27:03,144]\u001b[0m Trial 16 finished with value: 8.764642547342625 and parameters: {'n_estimators': 1583, 'max_depth': 5, 'learning_rate': 0.027228031944155778, 'subsample': 0.5837264937028799, 'colsample_bytree': 0.9983813146210843, 'min_child_weight': 6, 'reg_alpha': 0.060137121676944086, 'reg_lambda': 0.016245609911070345}. Best is trial 13 with value: 8.753994875578913.\u001b[0m\n",
      "\u001b[32m[I 2026-01-21 13:28:20,977]\u001b[0m Trial 17 finished with value: 8.750900245673574 and parameters: {'n_estimators': 1595, 'max_depth': 8, 'learning_rate': 0.018805919287232947, 'subsample': 0.6899355162910942, 'colsample_bytree': 0.7261047586048985, 'min_child_weight': 4, 'reg_alpha': 0.00033163390156361534, 'reg_lambda': 0.0012972610018336865}. Best is trial 17 with value: 8.750900245673574.\u001b[0m\n",
      "\u001b[32m[I 2026-01-21 13:29:39,133]\u001b[0m Trial 18 finished with value: 8.783350967903875 and parameters: {'n_estimators': 1621, 'max_depth': 8, 'learning_rate': 0.04212670053766945, 'subsample': 0.6890636089615132, 'colsample_bytree': 0.7180499167861399, 'min_child_weight': 4, 'reg_alpha': 0.0006961273852462093, 'reg_lambda': 0.17634752176572732}. Best is trial 17 with value: 8.750900245673574.\u001b[0m\n",
      "\u001b[32m[I 2026-01-21 13:30:46,693]\u001b[0m Trial 19 finished with value: 8.751705464690323 and parameters: {'n_estimators': 1351, 'max_depth': 8, 'learning_rate': 0.017317522727622218, 'subsample': 0.7299931044372592, 'colsample_bytree': 0.644941171417189, 'min_child_weight': 8, 'reg_alpha': 1.3689201077279095e-08, 'reg_lambda': 0.0008050280370218641}. Best is trial 17 with value: 8.750900245673574.\u001b[0m\n",
      "\u001b[32m[I 2026-01-21 13:31:55,818]\u001b[0m Trial 20 finished with value: 8.752753860169525 and parameters: {'n_estimators': 1377, 'max_depth': 8, 'learning_rate': 0.015292844895358967, 'subsample': 0.7416145419745023, 'colsample_bytree': 0.6091330191487015, 'min_child_weight': 9, 'reg_alpha': 8.15621309421382e-05, 'reg_lambda': 0.000764180383064087}. Best is trial 17 with value: 8.750900245673574.\u001b[0m\n",
      "\u001b[32m[I 2026-01-21 13:33:05,866]\u001b[0m Trial 21 finished with value: 8.753054537335673 and parameters: {'n_estimators': 1393, 'max_depth': 8, 'learning_rate': 0.014242530342040628, 'subsample': 0.7298595221890555, 'colsample_bytree': 0.6152165943488817, 'min_child_weight': 9, 'reg_alpha': 5.201483093717346e-05, 'reg_lambda': 0.0012679317598184223}. Best is trial 17 with value: 8.750900245673574.\u001b[0m\n",
      "\u001b[32m[I 2026-01-21 13:34:35,727]\u001b[0m Trial 22 finished with value: 8.748096981686475 and parameters: {'n_estimators': 1453, 'max_depth': 9, 'learning_rate': 0.01819450527813029, 'subsample': 0.8149271154876796, 'colsample_bytree': 0.5214259936218977, 'min_child_weight': 8, 'reg_alpha': 0.00015299452559238094, 'reg_lambda': 0.0015644308287124332}. Best is trial 22 with value: 8.748096981686475.\u001b[0m\n",
      "\u001b[32m[I 2026-01-21 13:36:08,586]\u001b[0m Trial 23 finished with value: 8.750216268544957 and parameters: {'n_estimators': 1522, 'max_depth': 9, 'learning_rate': 0.021411907840401777, 'subsample': 0.8203082183491407, 'colsample_bytree': 0.5307532714102643, 'min_child_weight': 8, 'reg_alpha': 3.3921736996170706e-08, 'reg_lambda': 6.818828220189241e-05}. Best is trial 22 with value: 8.748096981686475.\u001b[0m\n",
      "\u001b[32m[I 2026-01-21 13:37:49,678]\u001b[0m Trial 24 finished with value: 8.750811697244897 and parameters: {'n_estimators': 1679, 'max_depth': 9, 'learning_rate': 0.02030622519537168, 'subsample': 0.8106452018417594, 'colsample_bytree': 0.5114294375194237, 'min_child_weight': 8, 'reg_alpha': 3.099211102392938e-07, 'reg_lambda': 3.8923226201207206e-05}. Best is trial 22 with value: 8.748096981686475.\u001b[0m\n",
      "\u001b[32m[I 2026-01-21 13:39:30,411]\u001b[0m Trial 25 finished with value: 8.778229266127564 and parameters: {'n_estimators': 1711, 'max_depth': 9, 'learning_rate': 0.035496662066619104, 'subsample': 0.8389921364475589, 'colsample_bytree': 0.5050742057955246, 'min_child_weight': 8, 'reg_alpha': 2.0076596893114756e-07, 'reg_lambda': 5.7824070749391376e-06}. Best is trial 22 with value: 8.748096981686475.\u001b[0m\n",
      "\u001b[32m[I 2026-01-21 13:41:22,437]\u001b[0m Trial 26 finished with value: 8.878287633827473 and parameters: {'n_estimators': 1480, 'max_depth': 10, 'learning_rate': 0.05451431032507088, 'subsample': 0.8077834580598263, 'colsample_bytree': 0.5497238887986761, 'min_child_weight': 10, 'reg_alpha': 5.39337692342734e-07, 'reg_lambda': 5.505850044836728e-05}. Best is trial 22 with value: 8.748096981686475.\u001b[0m\n",
      "\u001b[32m[I 2026-01-21 13:43:07,602]\u001b[0m Trial 27 finished with value: 8.752732507929005 and parameters: {'n_estimators': 1752, 'max_depth': 9, 'learning_rate': 0.02055149313579281, 'subsample': 0.7901767233309864, 'colsample_bytree': 0.5004277088432257, 'min_child_weight': 8, 'reg_alpha': 9.881113185814322e-08, 'reg_lambda': 3.812440683135759e-06}. Best is trial 22 with value: 8.748096981686475.\u001b[0m\n",
      "\u001b[32m[I 2026-01-21 13:44:32,614]\u001b[0m Trial 28 finished with value: 8.777968167191023 and parameters: {'n_estimators': 1069, 'max_depth': 10, 'learning_rate': 0.031927984070726785, 'subsample': 0.8382836707899606, 'colsample_bytree': 0.569514426638738, 'min_child_weight': 8, 'reg_alpha': 1.4207329738625744e-06, 'reg_lambda': 0.00012975988337813924}. Best is trial 22 with value: 8.748096981686475.\u001b[0m\n",
      "\u001b[32m[I 2026-01-21 13:46:18,352]\u001b[0m Trial 29 finished with value: 8.753338650485507 and parameters: {'n_estimators': 1205, 'max_depth': 10, 'learning_rate': 0.013064791025461864, 'subsample': 0.7821985500114433, 'colsample_bytree': 0.585246540623044, 'min_child_weight': 7, 'reg_alpha': 7.586710350807279e-08, 'reg_lambda': 0.12836943076255267}. Best is trial 22 with value: 8.748096981686475.\u001b[0m\n"
     ]
    }
   ],
   "source": [
    "study = optuna.create_study(\n",
    "    direction=\"minimize\",\n",
    "    sampler=optuna.samplers.TPESampler(seed=CFG.RANDOM_SEED)\n",
    ")\n",
    "\n",
    "# use Optuna to find best parameter\n",
    "study.optimize(objective, n_trials=30)"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 9,
   "id": "c07ced37",
   "metadata": {
    "execution": {
     "iopub.execute_input": "2026-01-21T13:46:18.370405Z",
     "iopub.status.busy": "2026-01-21T13:46:18.370161Z",
     "iopub.status.idle": "2026-01-21T13:46:18.374897Z",
     "shell.execute_reply": "2026-01-21T13:46:18.374133Z"
    },
    "papermill": {
     "duration": 0.010983,
     "end_time": "2026-01-21T13:46:18.376240",
     "exception": false,
     "start_time": "2026-01-21T13:46:18.365257",
     "status": "completed"
    },
    "tags": []
   },
   "outputs": [
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "Best RMSE: 8.748096981686475\n",
      "Best params:\n",
      "n_estimators: 1453\n",
      "max_depth: 9\n",
      "learning_rate: 0.01819450527813029\n",
      "subsample: 0.8149271154876796\n",
      "colsample_bytree: 0.5214259936218977\n",
      "min_child_weight: 8\n",
      "reg_alpha: 0.00015299452559238094\n",
      "reg_lambda: 0.0015644308287124332\n"
     ]
    }
   ],
   "source": [
    "# 最佳參數\n",
    "print(\"Best RMSE:\", study.best_value)\n",
    "print(\"Best params:\")\n",
    "for k, v in study.best_params.items():\n",
    "    print(f\"{k}: {v}\")"
   ]
  },
  {
   "cell_type": "markdown",
   "id": "a289353d",
   "metadata": {
    "papermill": {
     "duration": 0.004018,
     "end_time": "2026-01-21T13:46:18.384375",
     "exception": false,
     "start_time": "2026-01-21T13:46:18.380357",
     "status": "completed"
    },
    "tags": []
   },
   "source": [
    "# Submission\n",
    "\n",
    "2026/01/19 Out-of-Fold (OOF)"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 10,
   "id": "bd67c97c",
   "metadata": {
    "execution": {
     "iopub.execute_input": "2026-01-21T13:46:18.393762Z",
     "iopub.status.busy": "2026-01-21T13:46:18.393228Z",
     "iopub.status.idle": "2026-01-21T13:46:18.396240Z",
     "shell.execute_reply": "2026-01-21T13:46:18.395719Z"
    },
    "papermill": {
     "duration": 0.009055,
     "end_time": "2026-01-21T13:46:18.397527",
     "exception": false,
     "start_time": "2026-01-21T13:46:18.388472",
     "status": "completed"
    },
    "tags": []
   },
   "outputs": [],
   "source": [
    "###########no OOF solution###############\n",
    "#final_pipeline = Pipeline(\n",
    "#    steps=[\n",
    "#        (\"preprocess\", Preprocessor()),\n",
    "#        (\"model\", XGBRegressor(\n",
    "#            **study.best_params,\n",
    "#            objective=\"reg:squarederror\",\n",
    "#            random_state=CFG.RANDOM_SEED,\n",
    "#            n_jobs=-1\n",
    "#        ))\n",
    "#    ]\n",
    "#)\n",
    "\n",
    "#final_pipeline.fit(X_train_raw, y_train)"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 11,
   "id": "c13c1723",
   "metadata": {
    "execution": {
     "iopub.execute_input": "2026-01-21T13:46:18.406859Z",
     "iopub.status.busy": "2026-01-21T13:46:18.406316Z",
     "iopub.status.idle": "2026-01-21T13:46:18.409585Z",
     "shell.execute_reply": "2026-01-21T13:46:18.408921Z"
    },
    "papermill": {
     "duration": 0.009332,
     "end_time": "2026-01-21T13:46:18.410934",
     "exception": false,
     "start_time": "2026-01-21T13:46:18.401602",
     "status": "completed"
    },
    "tags": []
   },
   "outputs": [],
   "source": [
    "#y_pred = final_pipeline.predict(test)\n",
    "\n",
    "#submission = pd.read_csv(CFG.sample_submission_csv)\n",
    "#test_id = test[\"id\"]\n",
    "#submission = pd.DataFrame({\n",
    "#    'Id': test_id, \n",
    "#    'exam_score': y_pred   \n",
    "#})\n",
    "\n",
    "#submission.to_csv('submission.csv', index=False)"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 12,
   "id": "da421e7b",
   "metadata": {
    "execution": {
     "iopub.execute_input": "2026-01-21T13:46:18.420178Z",
     "iopub.status.busy": "2026-01-21T13:46:18.419808Z",
     "iopub.status.idle": "2026-01-21T13:46:18.426188Z",
     "shell.execute_reply": "2026-01-21T13:46:18.425473Z"
    },
    "papermill": {
     "duration": 0.012561,
     "end_time": "2026-01-21T13:46:18.427508",
     "exception": false,
     "start_time": "2026-01-21T13:46:18.414947",
     "status": "completed"
    },
    "tags": []
   },
   "outputs": [],
   "source": [
    "def run_cv_and_predict(X, y, test_df, params):\n",
    "    kf = KFold(n_splits=CFG.N_FOLDS, shuffle=True, random_state=CFG.RANDOM_SEED)\n",
    "    \n",
    "    # Storage for OOF and Test predictions\n",
    "    oof_preds = np.zeros(len(X))\n",
    "    test_preds = np.zeros(len(test_df))\n",
    "    scores = []\n",
    "\n",
    "    for fold, (train_idx, val_idx) in enumerate(kf.split(X, y)):\n",
    "        X_train, X_val = X.iloc[train_idx], X.iloc[val_idx]\n",
    "        y_train, y_val = y.iloc[train_idx], y.iloc[val_idx]\n",
    "\n",
    "        # Preprocess inside the fold to prevent leakage\n",
    "        preprocessor = Preprocessor()\n",
    "        X_train_proc = preprocessor.fit_transform(X_train)\n",
    "        X_val_proc = preprocessor.transform(X_val)\n",
    "        X_test_proc = preprocessor.transform(test_df)\n",
    "\n",
    "        # Initialize Model\n",
    "        model = XGBRegressor(**params, random_state=CFG.RANDOM_SEED, n_jobs=-1)\n",
    "\n",
    "        # Fit with Early Stopping\n",
    "        model.fit(\n",
    "            X_train_proc, y_train,\n",
    "            eval_set=[(X_val_proc, y_val)],\n",
    "            verbose=False\n",
    "        )\n",
    "\n",
    "        # Predict\n",
    "        val_preds = model.predict(X_val_proc)\n",
    "        oof_preds[val_idx] = val_preds\n",
    "        test_preds += model.predict(X_test_proc) / CFG.N_FOLDS\n",
    "\n",
    "        # Score the fold\n",
    "        fold_rmse = mean_squared_error(y_val, val_preds)\n",
    "        scores.append(fold_rmse)\n",
    "        print(f\"Fold {fold+1} RMSE: {fold_rmse:.5f}\")\n",
    "\n",
    "    print(f\"\\nOverall CV RMSE: {np.mean(scores):.5f} +/- {np.std(scores):.5f}\")\n",
    "    return oof_preds, test_preds\n"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 13,
   "id": "846f9507",
   "metadata": {
    "execution": {
     "iopub.execute_input": "2026-01-21T13:46:18.436413Z",
     "iopub.status.busy": "2026-01-21T13:46:18.436195Z",
     "iopub.status.idle": "2026-01-21T13:50:57.779648Z",
     "shell.execute_reply": "2026-01-21T13:50:57.778835Z"
    },
    "papermill": {
     "duration": 279.34972,
     "end_time": "2026-01-21T13:50:57.781304",
     "exception": false,
     "start_time": "2026-01-21T13:46:18.431584",
     "status": "completed"
    },
    "tags": []
   },
   "outputs": [
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "Fold 1 RMSE: 76.38011\n",
      "Fold 2 RMSE: 76.44758\n",
      "Fold 3 RMSE: 76.37258\n",
      "Fold 4 RMSE: 76.66908\n",
      "Fold 5 RMSE: 77.00021\n",
      "\n",
      "Overall CV RMSE: 76.57391 +/- 0.23868\n"
     ]
    }
   ],
   "source": [
    "# run OOF with best parameter\n",
    "best_params = study.best_params\n",
    "oof_train, final_test_preds = run_cv_and_predict(X_train_raw, y_train, test, best_params)\n",
    "final_test_preds = np.round(final_test_preds,2)\n",
    "# submission\n",
    "submission = pd.DataFrame({\n",
    "    'id': test['id'],\n",
    "    'exam_score': final_test_preds # 這是 5 摺平均後的結果\n",
    "})\n",
    "submission.to_csv('submission.csv', index=False)"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 14,
   "id": "64dc01cf",
   "metadata": {
    "execution": {
     "iopub.execute_input": "2026-01-21T13:50:57.792147Z",
     "iopub.status.busy": "2026-01-21T13:50:57.791530Z",
     "iopub.status.idle": "2026-01-21T13:50:57.798601Z",
     "shell.execute_reply": "2026-01-21T13:50:57.797923Z"
    },
    "papermill": {
     "duration": 0.014204,
     "end_time": "2026-01-21T13:50:57.799964",
     "exception": false,
     "start_time": "2026-01-21T13:50:57.785760",
     "status": "completed"
    },
    "tags": []
   },
   "outputs": [
    {
     "data": {
      "text/html": [
       "<div>\n",
       "<style scoped>\n",
       "    .dataframe tbody tr th:only-of-type {\n",
       "        vertical-align: middle;\n",
       "    }\n",
       "\n",
       "    .dataframe tbody tr th {\n",
       "        vertical-align: top;\n",
       "    }\n",
       "\n",
       "    .dataframe thead th {\n",
       "        text-align: right;\n",
       "    }\n",
       "</style>\n",
       "<table border=\"1\" class=\"dataframe\">\n",
       "  <thead>\n",
       "    <tr style=\"text-align: right;\">\n",
       "      <th></th>\n",
       "      <th>id</th>\n",
       "      <th>exam_score</th>\n",
       "    </tr>\n",
       "  </thead>\n",
       "  <tbody>\n",
       "    <tr>\n",
       "      <th>0</th>\n",
       "      <td>630000</td>\n",
       "      <td>71.10</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>1</th>\n",
       "      <td>630001</td>\n",
       "      <td>70.84</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>2</th>\n",
       "      <td>630002</td>\n",
       "      <td>87.08</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>3</th>\n",
       "      <td>630003</td>\n",
       "      <td>55.36</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>4</th>\n",
       "      <td>630004</td>\n",
       "      <td>47.84</td>\n",
       "    </tr>\n",
       "  </tbody>\n",
       "</table>\n",
       "</div>"
      ],
      "text/plain": [
       "       id  exam_score\n",
       "0  630000       71.10\n",
       "1  630001       70.84\n",
       "2  630002       87.08\n",
       "3  630003       55.36\n",
       "4  630004       47.84"
      ]
     },
     "execution_count": 14,
     "metadata": {},
     "output_type": "execute_result"
    }
   ],
   "source": [
    "submission.head()"
   ]
  }
 ],
 "metadata": {
  "kaggle": {
   "accelerator": "nvidiaTeslaT4",
   "dataSources": [
    {
     "databundleVersionId": 14993753,
     "sourceId": 119082,
     "sourceType": "competition"
    }
   ],
   "dockerImageVersionId": 31234,
   "isGpuEnabled": true,
   "isInternetEnabled": true,
   "language": "python",
   "sourceType": "notebook"
  },
  "kernelspec": {
   "display_name": "Python 3",
   "language": "python",
   "name": "python3"
  },
  "language_info": {
   "codemirror_mode": {
    "name": "ipython",
    "version": 3
   },
   "file_extension": ".py",
   "mimetype": "text/x-python",
   "name": "python",
   "nbconvert_exporter": "python",
   "pygments_lexer": "ipython3",
   "version": "3.12.12"
  },
  "papermill": {
   "default_parameters": {},
   "duration": 2247.977379,
   "end_time": "2026-01-21T13:51:00.522053",
   "environment_variables": {},
   "exception": null,
   "input_path": "__notebook__.ipynb",
   "output_path": "__notebook__.ipynb",
   "parameters": {},
   "start_time": "2026-01-21T13:13:32.544674",
   "version": "2.6.0"
  }
 },
 "nbformat": 4,
 "nbformat_minor": 5
}
