{
 "cells": [
  {
   "cell_type": "markdown",
   "id": "711fe5ac",
   "metadata": {
    "papermill": {
     "duration": 0.00464,
     "end_time": "2026-01-16T15:14:42.722191",
     "exception": false,
     "start_time": "2026-01-16T15:14:42.717551",
     "status": "completed"
    },
    "tags": []
   },
   "source": [
    "# Outline\n",
    "\n",
    "This notebook include model training process and with optuna hyperparameter finding.\n",
    "\n",
    "Preprocess and feature Engineering is base on previous notebook.\n",
    "\n",
    "link : [https://www.kaggle.com/code/wesleyhuan/beginer-level-eda-season-6-episode-1](http://)\n",
    "\n",
    "Include these steps:\n",
    "\n",
    "* Load data\n",
    "* Preprocess data\n",
    "* Train model with Hyper parameter (OPTUNA)\n",
    "* Submission"
   ]
  },
  {
   "cell_type": "markdown",
   "id": "402e4a43",
   "metadata": {
    "papermill": {
     "duration": 0.003468,
     "end_time": "2026-01-16T15:14:42.729331",
     "exception": false,
     "start_time": "2026-01-16T15:14:42.725863",
     "status": "completed"
    },
    "tags": []
   },
   "source": [
    "# Load data"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 1,
   "id": "4d7922cf",
   "metadata": {
    "execution": {
     "iopub.execute_input": "2026-01-16T15:14:42.738492Z",
     "iopub.status.busy": "2026-01-16T15:14:42.738111Z",
     "iopub.status.idle": "2026-01-16T15:14:50.356125Z",
     "shell.execute_reply": "2026-01-16T15:14:50.354940Z"
    },
    "papermill": {
     "duration": 7.625697,
     "end_time": "2026-01-16T15:14:50.358468",
     "exception": false,
     "start_time": "2026-01-16T15:14:42.732771",
     "status": "completed"
    },
    "tags": []
   },
   "outputs": [
    {
     "name": "stderr",
     "output_type": "stream",
     "text": [
      "/usr/local/lib/python3.12/dist-packages/sqlalchemy/orm/query.py:195: SyntaxWarning: \"is not\" with 'tuple' literal. Did you mean \"!=\"?\n",
      "  if entities is not ():\n"
     ]
    }
   ],
   "source": [
    "# import necessary library\n",
    "import numpy as np # linear algebra\n",
    "import pandas as pd # data processing, CSV file I/O (e.g. pd.read_csv)\n",
    "import matplotlib.pyplot as plt\n",
    "import seaborn as sns\n",
    "\n",
    "from sklearn.preprocessing import OrdinalEncoder,LabelEncoder\n",
    "\n",
    "from xgboost import XGBRegressor\n",
    "from sklearn.metrics import mean_squared_error\n",
    "from sklearn.model_selection import train_test_split\n",
    "\n",
    "#for optuna pipline\n",
    "import optuna\n",
    "from sklearn.pipeline import Pipeline\n",
    "from sklearn.model_selection import KFold, cross_val_score\n",
    "from sklearn.base import BaseEstimator, TransformerMixin"
   ]
  },
  {
   "cell_type": "markdown",
   "id": "a56f26a7",
   "metadata": {
    "papermill": {
     "duration": 0.004118,
     "end_time": "2026-01-16T15:14:50.366301",
     "exception": false,
     "start_time": "2026-01-16T15:14:50.362183",
     "status": "completed"
    },
    "tags": []
   },
   "source": [
    "# Load data"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 2,
   "id": "bac08708",
   "metadata": {
    "execution": {
     "iopub.execute_input": "2026-01-16T15:14:50.377082Z",
     "iopub.status.busy": "2026-01-16T15:14:50.375454Z",
     "iopub.status.idle": "2026-01-16T15:14:50.381976Z",
     "shell.execute_reply": "2026-01-16T15:14:50.380910Z"
    },
    "papermill": {
     "duration": 0.013861,
     "end_time": "2026-01-16T15:14:50.384258",
     "exception": false,
     "start_time": "2026-01-16T15:14:50.370397",
     "status": "completed"
    },
    "tags": []
   },
   "outputs": [],
   "source": [
    "# config\n",
    "class CFG:\n",
    "    train_csv = '/kaggle/input/playground-series-s6e1/train.csv'\n",
    "    test_csv = '/kaggle/input/playground-series-s6e1/test.csv'\n",
    "    sample_submission_csv = '/kaggle/input/playground-series-s6e1/sample_submission.csv'\n",
    "    N_FOLDS = 5\n",
    "    RANDOM_SEED = 42\n",
    "    \n",
    "#torch.device('cuda' if torch.cuda.is_available() else 'cpu')\n",
    "#device = 'cuda' if torch.cuda.is_available() else 'cpu'"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 3,
   "id": "0f356d7b",
   "metadata": {
    "execution": {
     "iopub.execute_input": "2026-01-16T15:14:50.393611Z",
     "iopub.status.busy": "2026-01-16T15:14:50.393247Z",
     "iopub.status.idle": "2026-01-16T15:14:52.085318Z",
     "shell.execute_reply": "2026-01-16T15:14:52.083738Z"
    },
    "papermill": {
     "duration": 1.699534,
     "end_time": "2026-01-16T15:14:52.087530",
     "exception": false,
     "start_time": "2026-01-16T15:14:50.387996",
     "status": "completed"
    },
    "tags": []
   },
   "outputs": [],
   "source": [
    "train = pd.read_csv(CFG.train_csv)\n",
    "test = pd.read_csv(CFG.test_csv)"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 4,
   "id": "177c1edb",
   "metadata": {
    "execution": {
     "iopub.execute_input": "2026-01-16T15:14:52.098225Z",
     "iopub.status.busy": "2026-01-16T15:14:52.097159Z",
     "iopub.status.idle": "2026-01-16T15:14:52.140310Z",
     "shell.execute_reply": "2026-01-16T15:14:52.139325Z"
    },
    "papermill": {
     "duration": 0.051281,
     "end_time": "2026-01-16T15:14:52.142676",
     "exception": false,
     "start_time": "2026-01-16T15:14:52.091395",
     "status": "completed"
    },
    "tags": []
   },
   "outputs": [
    {
     "data": {
      "text/html": [
       "<div>\n",
       "<style scoped>\n",
       "    .dataframe tbody tr th:only-of-type {\n",
       "        vertical-align: middle;\n",
       "    }\n",
       "\n",
       "    .dataframe tbody tr th {\n",
       "        vertical-align: top;\n",
       "    }\n",
       "\n",
       "    .dataframe thead th {\n",
       "        text-align: right;\n",
       "    }\n",
       "</style>\n",
       "<table border=\"1\" class=\"dataframe\">\n",
       "  <thead>\n",
       "    <tr style=\"text-align: right;\">\n",
       "      <th></th>\n",
       "      <th>id</th>\n",
       "      <th>age</th>\n",
       "      <th>gender</th>\n",
       "      <th>course</th>\n",
       "      <th>study_hours</th>\n",
       "      <th>class_attendance</th>\n",
       "      <th>internet_access</th>\n",
       "      <th>sleep_hours</th>\n",
       "      <th>sleep_quality</th>\n",
       "      <th>study_method</th>\n",
       "      <th>facility_rating</th>\n",
       "      <th>exam_difficulty</th>\n",
       "    </tr>\n",
       "  </thead>\n",
       "  <tbody>\n",
       "    <tr>\n",
       "      <th>0</th>\n",
       "      <td>630000</td>\n",
       "      <td>24</td>\n",
       "      <td>other</td>\n",
       "      <td>ba</td>\n",
       "      <td>6.85</td>\n",
       "      <td>65.2</td>\n",
       "      <td>yes</td>\n",
       "      <td>5.2</td>\n",
       "      <td>poor</td>\n",
       "      <td>group study</td>\n",
       "      <td>high</td>\n",
       "      <td>easy</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>1</th>\n",
       "      <td>630001</td>\n",
       "      <td>18</td>\n",
       "      <td>male</td>\n",
       "      <td>diploma</td>\n",
       "      <td>6.61</td>\n",
       "      <td>45.0</td>\n",
       "      <td>no</td>\n",
       "      <td>9.3</td>\n",
       "      <td>poor</td>\n",
       "      <td>coaching</td>\n",
       "      <td>low</td>\n",
       "      <td>easy</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>2</th>\n",
       "      <td>630002</td>\n",
       "      <td>24</td>\n",
       "      <td>female</td>\n",
       "      <td>b.tech</td>\n",
       "      <td>6.60</td>\n",
       "      <td>98.5</td>\n",
       "      <td>yes</td>\n",
       "      <td>6.2</td>\n",
       "      <td>good</td>\n",
       "      <td>group study</td>\n",
       "      <td>medium</td>\n",
       "      <td>moderate</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>3</th>\n",
       "      <td>630003</td>\n",
       "      <td>24</td>\n",
       "      <td>male</td>\n",
       "      <td>diploma</td>\n",
       "      <td>3.03</td>\n",
       "      <td>66.3</td>\n",
       "      <td>yes</td>\n",
       "      <td>5.7</td>\n",
       "      <td>average</td>\n",
       "      <td>mixed</td>\n",
       "      <td>medium</td>\n",
       "      <td>moderate</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>4</th>\n",
       "      <td>630004</td>\n",
       "      <td>20</td>\n",
       "      <td>female</td>\n",
       "      <td>b.tech</td>\n",
       "      <td>2.03</td>\n",
       "      <td>42.4</td>\n",
       "      <td>yes</td>\n",
       "      <td>9.2</td>\n",
       "      <td>average</td>\n",
       "      <td>coaching</td>\n",
       "      <td>low</td>\n",
       "      <td>moderate</td>\n",
       "    </tr>\n",
       "  </tbody>\n",
       "</table>\n",
       "</div>"
      ],
      "text/plain": [
       "       id  age  gender   course  study_hours  class_attendance  \\\n",
       "0  630000   24   other       ba         6.85              65.2   \n",
       "1  630001   18    male  diploma         6.61              45.0   \n",
       "2  630002   24  female   b.tech         6.60              98.5   \n",
       "3  630003   24    male  diploma         3.03              66.3   \n",
       "4  630004   20  female   b.tech         2.03              42.4   \n",
       "\n",
       "  internet_access  sleep_hours sleep_quality study_method facility_rating  \\\n",
       "0             yes          5.2          poor  group study            high   \n",
       "1              no          9.3          poor     coaching             low   \n",
       "2             yes          6.2          good  group study          medium   \n",
       "3             yes          5.7       average        mixed          medium   \n",
       "4             yes          9.2       average     coaching             low   \n",
       "\n",
       "  exam_difficulty  \n",
       "0            easy  \n",
       "1            easy  \n",
       "2        moderate  \n",
       "3        moderate  \n",
       "4        moderate  "
      ]
     },
     "execution_count": 4,
     "metadata": {},
     "output_type": "execute_result"
    }
   ],
   "source": [
    "test.head()"
   ]
  },
  {
   "cell_type": "markdown",
   "id": "ab87a6d2",
   "metadata": {
    "papermill": {
     "duration": 0.003854,
     "end_time": "2026-01-16T15:14:52.150569",
     "exception": false,
     "start_time": "2026-01-16T15:14:52.146715",
     "status": "completed"
    },
    "tags": []
   },
   "source": [
    "# Preprocess data\n",
    "\n",
    "2026/01/13\n",
    "change into class for pipline"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 5,
   "id": "b73e89c2",
   "metadata": {
    "execution": {
     "iopub.execute_input": "2026-01-16T15:14:52.160445Z",
     "iopub.status.busy": "2026-01-16T15:14:52.159877Z",
     "iopub.status.idle": "2026-01-16T15:14:52.177797Z",
     "shell.execute_reply": "2026-01-16T15:14:52.176327Z"
    },
    "papermill": {
     "duration": 0.025763,
     "end_time": "2026-01-16T15:14:52.180097",
     "exception": false,
     "start_time": "2026-01-16T15:14:52.154334",
     "status": "completed"
    },
    "tags": []
   },
   "outputs": [],
   "source": [
    "class Preprocessor(BaseEstimator, TransformerMixin):\n",
    "    def __init__(self):\n",
    "        self.medians = {}\n",
    "        self.encoders = {}\n",
    "        self.numeric_cols = []\n",
    "        self.all_non_numeric = []\n",
    "        self.categorical_cols = []\n",
    "        self.level_mapping = {'easy': 1, 'moderate': 2, 'hard': 3,\n",
    "                              'low': 1, 'medium': 2, 'high': 3,\n",
    "                              'poor': 1, 'average': 2, 'good': 3}\n",
    "        self.level_cols = ['sleep_quality', 'facility_rating', 'exam_difficulty']\n",
    "        \n",
    "    def fit(self, df, y=None):\n",
    "        \"\"\"\n",
    "        Learn the parameters (medians, categories) from the TRAINING data.\n",
    "        \"\"\"\n",
    "        # Identify columns\n",
    "        self.numeric_cols = df.select_dtypes(include=[np.number]).columns.tolist()\n",
    "        self.all_non_numeric = df.select_dtypes(exclude=[np.number]).columns.tolist()\n",
    "        self.categorical_cols = [c for c in self.all_non_numeric if c not in self.level_cols]\n",
    "        \n",
    "        # Learn Medians for numeric columns\n",
    "        for col in self.numeric_cols:\n",
    "            self.medians[col] = df[col].median()\n",
    "            \n",
    "        # Fit Encoders for categorical columns\n",
    "        # handle_unknown='use_encoded_value' prevents crashes if Test data has new categories\n",
    "        for col in self.categorical_cols:\n",
    "            enc = OrdinalEncoder(handle_unknown='use_encoded_value', unknown_value=-1)\n",
    "            enc.fit(df[[col]].astype(str)) \n",
    "            self.encoders[col] = enc\n",
    "            \n",
    "        return self\n",
    "\n",
    "    def transform(self, df):\n",
    "        \"\"\"\n",
    "        Apply the learned parameters to the data (Train or Test).\n",
    "        \"\"\"\n",
    "        df = df.copy()\n",
    "        \n",
    "        # Drop irrelevant columns (ID is usually dropped, Target handled separately)\n",
    "        # Note: We don't drop target here to keep X and y aligned until the end\n",
    "        if 'id' in df.columns:\n",
    "            df = df.drop(columns=['id'])\n",
    "        if 'exam_score' in df.columns:\n",
    "            df = df.drop(columns=['exam_score'])\n",
    "\n",
    "        # level encoding\n",
    "        for col in self.level_cols:\n",
    "            if col in df.columns:\n",
    "                # ues mapping rule fillna with 0 \n",
    "                df[col] = df[col].map(self.level_mapping).fillna(0).astype(int)\n",
    "        # Impute Missing Values using LEARNED medians\n",
    "        for col in self.numeric_cols:\n",
    "            if col in df.columns:\n",
    "                df[col] = df[col].fillna(self.medians.get(col, 0))\n",
    "        \n",
    "        # Apply Encoding\n",
    "        for col in self.categorical_cols:\n",
    "            if col in df.columns:\n",
    "                # Fill NaN in categoricals with 'Missing' before encoding to be safe\n",
    "                df[col] = df[col].astype(str).fillna('Missing')\n",
    "                df[col] = self.encoders[col].transform(df[[col]]).flatten()\n",
    "\n",
    "        # interaction features\n",
    "        df = self.create_interaction_features(df)\n",
    "        \n",
    "        return df\n",
    "        \n",
    "    def create_interaction_features(self, df):# add because of the Correlation matrix\n",
    "        df = df.copy()\n",
    "        \n",
    "        # sleep_hours * sleep_quality\n",
    "        # assumption : sleep_quality might increase value of sleep_hours\n",
    "        if 'sleep_hours' in df.columns and 'sleep_quality' in df.columns:\n",
    "            df['sleep_hours_quality'] = df['sleep_hours'] * df['sleep_quality']\n",
    "            \n",
    "        # class_attendance * facility_rating\n",
    "        # assumption : better facility_rating with increase the effect class_attendance\n",
    "        if 'class_attendance' in df.columns and 'facility_rating' in df.columns:\n",
    "            df['facility_rating_attendance'] = df['class_attendance'] * df['facility_rating']\n",
    "            \n",
    "        # study_method * study_hours\n",
    "        # study_method might increase value of study_hours\n",
    "        if 'study_method' in df.columns and 'study_hours' in df.columns:\n",
    "            df['study_method_hours'] = df['study_method'] * df['study_hours']\n",
    "        \n",
    "        return df"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 6,
   "id": "c4788ea0",
   "metadata": {
    "execution": {
     "iopub.execute_input": "2026-01-16T15:14:52.191442Z",
     "iopub.status.busy": "2026-01-16T15:14:52.191035Z",
     "iopub.status.idle": "2026-01-16T15:14:52.197052Z",
     "shell.execute_reply": "2026-01-16T15:14:52.195533Z"
    },
    "papermill": {
     "duration": 0.014658,
     "end_time": "2026-01-16T15:14:52.199532",
     "exception": false,
     "start_time": "2026-01-16T15:14:52.184874",
     "status": "completed"
    },
    "tags": []
   },
   "outputs": [],
   "source": [
    "X_train_raw = train#.drop(columns=['exam_score'])\n",
    "y_train = train['exam_score']"
   ]
  },
  {
   "cell_type": "markdown",
   "id": "979faabe",
   "metadata": {
    "papermill": {
     "duration": 0.003829,
     "end_time": "2026-01-16T15:14:52.207349",
     "exception": false,
     "start_time": "2026-01-16T15:14:52.203520",
     "status": "completed"
    },
    "tags": []
   },
   "source": [
    "# Train model with Hyper parameter (OPTUNA) \n",
    "\n",
    "2026/01/13 reach TOP 30%\n",
    "1. add optuna for hyperparameter \n",
    "2. cross validation \n",
    "3. combine preprocessor and model into pip line"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 7,
   "id": "f7eba458",
   "metadata": {
    "execution": {
     "iopub.execute_input": "2026-01-16T15:14:52.216846Z",
     "iopub.status.busy": "2026-01-16T15:14:52.216503Z",
     "iopub.status.idle": "2026-01-16T15:14:52.224927Z",
     "shell.execute_reply": "2026-01-16T15:14:52.223793Z"
    },
    "papermill": {
     "duration": 0.016278,
     "end_time": "2026-01-16T15:14:52.227541",
     "exception": false,
     "start_time": "2026-01-16T15:14:52.211263",
     "status": "completed"
    },
    "tags": []
   },
   "outputs": [],
   "source": [
    "def objective(trial):\n",
    "\n",
    "    model_params = {\n",
    "        \"n_estimators\": trial.suggest_int(\"n_estimators\", 300, 2000),\n",
    "        \"max_depth\": trial.suggest_int(\"max_depth\", 3, 10),\n",
    "        \"learning_rate\": trial.suggest_float(\"learning_rate\", 0.01, 0.2, log=True),\n",
    "        \"subsample\": trial.suggest_float(\"subsample\", 0.6, 1.0),\n",
    "        \"colsample_bytree\": trial.suggest_float(\"colsample_bytree\", 0.6, 1.0),\n",
    "        \"min_child_weight\": trial.suggest_int(\"min_child_weight\", 1, 10),\n",
    "        \"reg_alpha\": trial.suggest_float(\"reg_alpha\", 1e-8, 10.0, log=True),\n",
    "        \"reg_lambda\": trial.suggest_float(\"reg_lambda\", 1e-8, 10.0, log=True),\n",
    "    }\n",
    "\n",
    "    pipeline = Pipeline(\n",
    "        steps=[\n",
    "            (\"preprocess\", Preprocessor()),\n",
    "            (\"model\", XGBRegressor(\n",
    "                objective=\"reg:squarederror\",\n",
    "                random_state=CFG.RANDOM_SEED,\n",
    "                n_jobs=-1,\n",
    "                **model_params\n",
    "            ))\n",
    "        ]\n",
    "    )\n",
    "\n",
    "    scores = cross_val_score(\n",
    "        pipeline,\n",
    "        X_train_raw,\n",
    "        y_train,\n",
    "        cv=4,\n",
    "        scoring=\"neg_root_mean_squared_error\",\n",
    "        n_jobs=-1\n",
    "    )\n",
    "\n",
    "    return -scores.mean()"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 8,
   "id": "1bd6e2d2",
   "metadata": {
    "execution": {
     "iopub.execute_input": "2026-01-16T15:14:52.237281Z",
     "iopub.status.busy": "2026-01-16T15:14:52.236834Z",
     "iopub.status.idle": "2026-01-16T16:16:22.827186Z",
     "shell.execute_reply": "2026-01-16T16:16:22.825761Z"
    },
    "papermill": {
     "duration": 3690.602577,
     "end_time": "2026-01-16T16:16:22.834056",
     "exception": false,
     "start_time": "2026-01-16T15:14:52.231479",
     "status": "completed"
    },
    "tags": []
   },
   "outputs": [
    {
     "name": "stderr",
     "output_type": "stream",
     "text": [
      "\u001b[32m[I 2026-01-16 15:14:52,239]\u001b[0m A new study created in memory with name: no-name-56067fce-e2ce-4177-a182-52c9737de950\u001b[0m\n",
      "\u001b[32m[I 2026-01-16 15:17:13,728]\u001b[0m Trial 0 finished with value: 8.963016699712202 and parameters: {'n_estimators': 937, 'max_depth': 10, 'learning_rate': 0.08960785365368121, 'subsample': 0.8394633936788146, 'colsample_bytree': 0.6624074561769746, 'min_child_weight': 2, 'reg_alpha': 3.3323645788192616e-08, 'reg_lambda': 0.6245760287469893}. Best is trial 0 with value: 8.963016699712202.\u001b[0m\n",
      "\u001b[32m[I 2026-01-16 15:19:54,054]\u001b[0m Trial 1 finished with value: 8.771974928743035 and parameters: {'n_estimators': 1322, 'max_depth': 8, 'learning_rate': 0.010636066512540286, 'subsample': 0.9879639408647978, 'colsample_bytree': 0.9329770563201687, 'min_child_weight': 3, 'reg_alpha': 4.329370014459266e-07, 'reg_lambda': 4.4734294104626844e-07}. Best is trial 1 with value: 8.771974928743035.\u001b[0m\n",
      "\u001b[32m[I 2026-01-16 15:21:15,940]\u001b[0m Trial 2 finished with value: 8.759908012739505 and parameters: {'n_estimators': 817, 'max_depth': 7, 'learning_rate': 0.03647316284911211, 'subsample': 0.7164916560792167, 'colsample_bytree': 0.8447411578889518, 'min_child_weight': 2, 'reg_alpha': 4.258943089524393e-06, 'reg_lambda': 1.9826980964985924e-05}. Best is trial 2 with value: 8.759908012739505.\u001b[0m\n",
      "\u001b[32m[I 2026-01-16 15:23:41,903]\u001b[0m Trial 3 finished with value: 8.761375610943428 and parameters: {'n_estimators': 1075, 'max_depth': 9, 'learning_rate': 0.018187859051288217, 'subsample': 0.8056937753654446, 'colsample_bytree': 0.836965827544817, 'min_child_weight': 1, 'reg_alpha': 0.0029369981104377003, 'reg_lambda': 3.425445902633376e-07}. Best is trial 2 with value: 8.759908012739505.\u001b[0m\n",
      "\u001b[32m[I 2026-01-16 15:24:43,758]\u001b[0m Trial 4 finished with value: 9.07453180150926 and parameters: {'n_estimators': 410, 'max_depth': 10, 'learning_rate': 0.18043311207136256, 'subsample': 0.9233589392465844, 'colsample_bytree': 0.7218455076693483, 'min_child_weight': 1, 'reg_alpha': 0.014391207615728067, 'reg_lambda': 9.148975058772307e-05}. Best is trial 2 with value: 8.759908012739505.\u001b[0m\n",
      "\u001b[32m[I 2026-01-16 15:25:40,412]\u001b[0m Trial 5 finished with value: 8.824122238721806 and parameters: {'n_estimators': 507, 'max_depth': 6, 'learning_rate': 0.011085122517311707, 'subsample': 0.9637281608315128, 'colsample_bytree': 0.7035119926400067, 'min_child_weight': 7, 'reg_alpha': 6.388511557344611e-06, 'reg_lambda': 0.0004793052550782129}. Best is trial 2 with value: 8.759908012739505.\u001b[0m\n",
      "\u001b[32m[I 2026-01-16 15:26:51,780]\u001b[0m Trial 6 finished with value: 8.766157748175951 and parameters: {'n_estimators': 1229, 'max_depth': 4, 'learning_rate': 0.18258230439200238, 'subsample': 0.9100531293444458, 'colsample_bytree': 0.9757995766256756, 'min_child_weight': 9, 'reg_alpha': 0.002404915432737351, 'reg_lambda': 1.9809253750493907}. Best is trial 2 with value: 8.759908012739505.\u001b[0m\n",
      "\u001b[32m[I 2026-01-16 15:27:28,419]\u001b[0m Trial 7 finished with value: 8.907778997240886 and parameters: {'n_estimators': 450, 'max_depth': 4, 'learning_rate': 0.011450964268326641, 'subsample': 0.7301321323053057, 'colsample_bytree': 0.7554709158757928, 'min_child_weight': 3, 'reg_alpha': 0.28749982347407854, 'reg_lambda': 1.6247252885719427e-05}. Best is trial 2 with value: 8.759908012739505.\u001b[0m\n",
      "\u001b[32m[I 2026-01-16 15:28:55,205]\u001b[0m Trial 8 finished with value: 8.776230891408117 and parameters: {'n_estimators': 777, 'max_depth': 7, 'learning_rate': 0.015252697030515175, 'subsample': 0.9208787923016158, 'colsample_bytree': 0.6298202574719083, 'min_child_weight': 10, 'reg_alpha': 0.08916674715636537, 'reg_lambda': 6.143857495033091e-07}. Best is trial 2 with value: 8.759908012739505.\u001b[0m\n",
      "\u001b[32m[I 2026-01-16 15:29:38,725]\u001b[0m Trial 9 finished with value: 8.79609287275491 and parameters: {'n_estimators': 309, 'max_depth': 9, 'learning_rate': 0.08310795711416077, 'subsample': 0.8916028672163949, 'colsample_bytree': 0.9085081386743783, 'min_child_weight': 1, 'reg_alpha': 1.683416412018213e-05, 'reg_lambda': 1.1036250149900698e-07}. Best is trial 2 with value: 8.759908012739505.\u001b[0m\n",
      "\u001b[32m[I 2026-01-16 15:32:09,705]\u001b[0m Trial 10 finished with value: 8.754976573049811 and parameters: {'n_estimators': 1773, 'max_depth': 6, 'learning_rate': 0.030180553031924493, 'subsample': 0.6071847502459278, 'colsample_bytree': 0.8277250010609204, 'min_child_weight': 5, 'reg_alpha': 4.344469108550388, 'reg_lambda': 0.010039786460205676}. Best is trial 10 with value: 8.754976573049811.\u001b[0m\n",
      "\u001b[32m[I 2026-01-16 15:34:52,819]\u001b[0m Trial 11 finished with value: 8.754294380381458 and parameters: {'n_estimators': 1910, 'max_depth': 6, 'learning_rate': 0.030364484777630107, 'subsample': 0.6041532519630008, 'colsample_bytree': 0.83445433467569, 'min_child_weight': 5, 'reg_alpha': 4.188416507348488, 'reg_lambda': 0.008427137829973086}. Best is trial 11 with value: 8.754294380381458.\u001b[0m\n",
      "\u001b[32m[I 2026-01-16 15:37:14,396]\u001b[0m Trial 12 finished with value: 8.75792532968567 and parameters: {'n_estimators': 1954, 'max_depth': 5, 'learning_rate': 0.033259005086604364, 'subsample': 0.6014245292403245, 'colsample_bytree': 0.7957611591204394, 'min_child_weight': 5, 'reg_alpha': 8.964592852736434, 'reg_lambda': 0.014790975660203091}. Best is trial 11 with value: 8.754294380381458.\u001b[0m\n",
      "\u001b[32m[I 2026-01-16 15:40:03,794]\u001b[0m Trial 13 finished with value: 8.754468762207129 and parameters: {'n_estimators': 1984, 'max_depth': 6, 'learning_rate': 0.024795758443471035, 'subsample': 0.6039698962347247, 'colsample_bytree': 0.8604063212686378, 'min_child_weight': 6, 'reg_alpha': 9.868745464853761, 'reg_lambda': 0.018313125916897974}. Best is trial 11 with value: 8.754294380381458.\u001b[0m\n",
      "\u001b[32m[I 2026-01-16 15:41:29,619]\u001b[0m Trial 14 finished with value: 8.808209968039085 and parameters: {'n_estimators': 1594, 'max_depth': 3, 'learning_rate': 0.022793276266251813, 'subsample': 0.6638123593227386, 'colsample_bytree': 0.8919339318126805, 'min_child_weight': 7, 'reg_alpha': 0.6263415587377541, 'reg_lambda': 0.04394253214905615}. Best is trial 11 with value: 8.754294380381458.\u001b[0m\n",
      "\u001b[32m[I 2026-01-16 15:43:49,193]\u001b[0m Trial 15 finished with value: 8.75608556756523 and parameters: {'n_estimators': 2000, 'max_depth': 5, 'learning_rate': 0.056680812250788054, 'subsample': 0.6743111737417404, 'colsample_bytree': 0.7809305251510433, 'min_child_weight': 7, 'reg_alpha': 0.00016314022735956427, 'reg_lambda': 0.0012602438198154038}. Best is trial 11 with value: 8.754294380381458.\u001b[0m\n",
      "\u001b[32m[I 2026-01-16 15:45:42,718]\u001b[0m Trial 16 finished with value: 8.758313232560797 and parameters: {'n_estimators': 1591, 'max_depth': 5, 'learning_rate': 0.053309249936217905, 'subsample': 0.6517327282408382, 'colsample_bytree': 0.9980085299979685, 'min_child_weight': 6, 'reg_alpha': 1.4327280108234954, 'reg_lambda': 0.2818936773599518}. Best is trial 11 with value: 8.754294380381458.\u001b[0m\n",
      "\u001b[32m[I 2026-01-16 15:48:19,784]\u001b[0m Trial 17 finished with value: 8.757834397618282 and parameters: {'n_estimators': 1440, 'max_depth': 8, 'learning_rate': 0.024422696775104804, 'subsample': 0.754935807554969, 'colsample_bytree': 0.8813641111154343, 'min_child_weight': 4, 'reg_alpha': 0.040262466210226146, 'reg_lambda': 4.966554570452669}. Best is trial 11 with value: 8.754294380381458.\u001b[0m\n",
      "\u001b[32m[I 2026-01-16 15:50:50,422]\u001b[0m Trial 18 finished with value: 8.759734398964477 and parameters: {'n_estimators': 1780, 'max_depth': 6, 'learning_rate': 0.044513380330428655, 'subsample': 0.6412545650370052, 'colsample_bytree': 0.9469236812814982, 'min_child_weight': 8, 'reg_alpha': 9.863818452504152, 'reg_lambda': 0.002479139707980859}. Best is trial 11 with value: 8.754294380381458.\u001b[0m\n",
      "\u001b[32m[I 2026-01-16 15:52:26,551]\u001b[0m Trial 19 finished with value: 8.812995543211475 and parameters: {'n_estimators': 1796, 'max_depth': 3, 'learning_rate': 0.017317522727622218, 'subsample': 0.7174578137346916, 'colsample_bytree': 0.8658599058549207, 'min_child_weight': 6, 'reg_alpha': 0.4385329933199028, 'reg_lambda': 0.07597722560775576}. Best is trial 11 with value: 8.754294380381458.\u001b[0m\n",
      "\u001b[32m[I 2026-01-16 15:54:59,809]\u001b[0m Trial 20 finished with value: 8.752383934649863 and parameters: {'n_estimators': 1625, 'max_depth': 7, 'learning_rate': 0.022868032935380388, 'subsample': 0.7716870468962868, 'colsample_bytree': 0.7581014414297597, 'min_child_weight': 4, 'reg_alpha': 0.00022496116000185, 'reg_lambda': 0.004939392464663163}. Best is trial 20 with value: 8.752383934649863.\u001b[0m\n",
      "\u001b[32m[I 2026-01-16 15:57:26,560]\u001b[0m Trial 21 finished with value: 8.753162139010632 and parameters: {'n_estimators': 1578, 'max_depth': 7, 'learning_rate': 0.027422903328062274, 'subsample': 0.782297495743992, 'colsample_bytree': 0.7458679725121594, 'min_child_weight': 4, 'reg_alpha': 0.00040519641183382776, 'reg_lambda': 0.007032817545601335}. Best is trial 20 with value: 8.752383934649863.\u001b[0m\n",
      "\u001b[32m[I 2026-01-16 16:00:11,553]\u001b[0m Trial 22 finished with value: 8.780501770476238 and parameters: {'n_estimators': 1549, 'max_depth': 8, 'learning_rate': 0.03968666775294414, 'subsample': 0.7817169487923574, 'colsample_bytree': 0.7431112214919918, 'min_child_weight': 4, 'reg_alpha': 0.00013800473711850868, 'reg_lambda': 0.00010855365719104567}. Best is trial 20 with value: 8.752383934649863.\u001b[0m\n",
      "\u001b[32m[I 2026-01-16 16:02:23,245]\u001b[0m Trial 23 finished with value: 8.752887167954595 and parameters: {'n_estimators': 1416, 'max_depth': 7, 'learning_rate': 0.0264534610143714, 'subsample': 0.8251323334561256, 'colsample_bytree': 0.6872276215369536, 'min_child_weight': 4, 'reg_alpha': 0.00044706747801014063, 'reg_lambda': 0.0020932616357817167}. Best is trial 20 with value: 8.752383934649863.\u001b[0m\n",
      "\u001b[32m[I 2026-01-16 16:04:34,804]\u001b[0m Trial 24 finished with value: 8.754428573862633 and parameters: {'n_estimators': 1391, 'max_depth': 7, 'learning_rate': 0.020566861211876807, 'subsample': 0.8485161614734077, 'colsample_bytree': 0.6604602655220193, 'min_child_weight': 4, 'reg_alpha': 0.0008562750022158666, 'reg_lambda': 0.001737046626043056}. Best is trial 20 with value: 8.752383934649863.\u001b[0m\n",
      "\u001b[32m[I 2026-01-16 16:06:50,304]\u001b[0m Trial 25 finished with value: 8.756914743048874 and parameters: {'n_estimators': 1133, 'max_depth': 8, 'learning_rate': 0.015462916478228495, 'subsample': 0.8099723578056508, 'colsample_bytree': 0.6057575681173106, 'min_child_weight': 3, 'reg_alpha': 4.174709250189763e-05, 'reg_lambda': 0.15107416462183854}. Best is trial 20 with value: 8.752383934649863.\u001b[0m\n",
      "\u001b[32m[I 2026-01-16 16:09:21,002]\u001b[0m Trial 26 finished with value: 8.771989632333792 and parameters: {'n_estimators': 1684, 'max_depth': 7, 'learning_rate': 0.05451431032507088, 'subsample': 0.8569070493304349, 'colsample_bytree': 0.6958697600914534, 'min_child_weight': 4, 'reg_alpha': 0.0006512690238598171, 'reg_lambda': 6.9912459789873285e-06}. Best is trial 20 with value: 8.752383934649863.\u001b[0m\n",
      "\u001b[32m[I 2026-01-16 16:12:27,027]\u001b[0m Trial 27 finished with value: 8.782381793930194 and parameters: {'n_estimators': 1474, 'max_depth': 9, 'learning_rate': 0.0286433639800131, 'subsample': 0.7658373612600313, 'colsample_bytree': 0.7633486849570302, 'min_child_weight': 2, 'reg_alpha': 1.0768698990306878e-06, 'reg_lambda': 0.00022579208325434582}. Best is trial 20 with value: 8.752383934649863.\u001b[0m\n",
      "\u001b[32m[I 2026-01-16 16:14:20,384]\u001b[0m Trial 28 finished with value: 8.780705588470449 and parameters: {'n_estimators': 1258, 'max_depth': 7, 'learning_rate': 0.07172919547978202, 'subsample': 0.8300588325133295, 'colsample_bytree': 0.6758286439953978, 'min_child_weight': 3, 'reg_alpha': 7.293494857283485e-05, 'reg_lambda': 1.6902749588425065e-08}. Best is trial 20 with value: 8.752383934649863.\u001b[0m\n",
      "\u001b[32m[I 2026-01-16 16:16:22,822]\u001b[0m Trial 29 finished with value: 8.76303971126759 and parameters: {'n_estimators': 1000, 'max_depth': 8, 'learning_rate': 0.013886102402132406, 'subsample': 0.7498682553622409, 'colsample_bytree': 0.7268929508862564, 'min_child_weight': 2, 'reg_alpha': 0.0069490400712321826, 'reg_lambda': 0.49515167818529787}. Best is trial 20 with value: 8.752383934649863.\u001b[0m\n"
     ]
    }
   ],
   "source": [
    "study = optuna.create_study(\n",
    "    direction=\"minimize\",\n",
    "    sampler=optuna.samplers.TPESampler(seed=CFG.RANDOM_SEED)\n",
    ")\n",
    "\n",
    "study.optimize(objective, n_trials=30)"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 9,
   "id": "b097b57e",
   "metadata": {
    "execution": {
     "iopub.execute_input": "2026-01-16T16:16:22.847764Z",
     "iopub.status.busy": "2026-01-16T16:16:22.847375Z",
     "iopub.status.idle": "2026-01-16T16:17:22.088815Z",
     "shell.execute_reply": "2026-01-16T16:17:22.087895Z"
    },
    "papermill": {
     "duration": 59.251722,
     "end_time": "2026-01-16T16:17:22.091647",
     "exception": false,
     "start_time": "2026-01-16T16:16:22.839925",
     "status": "completed"
    },
    "tags": []
   },
   "outputs": [],
   "source": [
    "final_pipeline = Pipeline(\n",
    "    steps=[\n",
    "        (\"preprocess\", Preprocessor()),\n",
    "        (\"model\", XGBRegressor(\n",
    "            **study.best_params,\n",
    "            objective=\"reg:squarederror\",\n",
    "            random_state=CFG.RANDOM_SEED,\n",
    "            n_jobs=-1\n",
    "        ))\n",
    "    ]\n",
    ")\n",
    "\n",
    "final_pipeline.fit(X_train_raw, y_train)\n",
    "\n",
    "y_pred = final_pipeline.predict(test)\n"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 10,
   "id": "43f298ad",
   "metadata": {
    "execution": {
     "iopub.execute_input": "2026-01-16T16:17:22.106618Z",
     "iopub.status.busy": "2026-01-16T16:17:22.105385Z",
     "iopub.status.idle": "2026-01-16T16:17:22.112544Z",
     "shell.execute_reply": "2026-01-16T16:17:22.111428Z"
    },
    "papermill": {
     "duration": 0.016245,
     "end_time": "2026-01-16T16:17:22.114744",
     "exception": false,
     "start_time": "2026-01-16T16:17:22.098499",
     "status": "completed"
    },
    "tags": []
   },
   "outputs": [
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "Best RMSE: 8.752383934649863\n",
      "Best params:\n",
      "n_estimators: 1625\n",
      "max_depth: 7\n",
      "learning_rate: 0.022868032935380388\n",
      "subsample: 0.7716870468962868\n",
      "colsample_bytree: 0.7581014414297597\n",
      "min_child_weight: 4\n",
      "reg_alpha: 0.00022496116000185\n",
      "reg_lambda: 0.004939392464663163\n"
     ]
    }
   ],
   "source": [
    "# 最佳參數\n",
    "print(\"Best RMSE:\", study.best_value)\n",
    "print(\"Best params:\")\n",
    "for k, v in study.best_params.items():\n",
    "    print(f\"{k}: {v}\")"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 11,
   "id": "59f2dfb3",
   "metadata": {
    "execution": {
     "iopub.execute_input": "2026-01-16T16:17:22.128260Z",
     "iopub.status.busy": "2026-01-16T16:17:22.127866Z",
     "iopub.status.idle": "2026-01-16T16:17:22.132286Z",
     "shell.execute_reply": "2026-01-16T16:17:22.131292Z"
    },
    "papermill": {
     "duration": 0.014133,
     "end_time": "2026-01-16T16:17:22.134503",
     "exception": false,
     "start_time": "2026-01-16T16:17:22.120370",
     "status": "completed"
    },
    "tags": []
   },
   "outputs": [],
   "source": [
    "# visualize data\n",
    "#optuna.visualization.plot_optimization_history(study)\n",
    "#optuna.visualization.plot_param_importances(study)"
   ]
  },
  {
   "cell_type": "markdown",
   "id": "76a9df50",
   "metadata": {
    "papermill": {
     "duration": 0.005423,
     "end_time": "2026-01-16T16:17:22.145747",
     "exception": false,
     "start_time": "2026-01-16T16:17:22.140324",
     "status": "completed"
    },
    "tags": []
   },
   "source": [
    "# Submission"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 12,
   "id": "3fe12c40",
   "metadata": {
    "execution": {
     "iopub.execute_input": "2026-01-16T16:17:22.161131Z",
     "iopub.status.busy": "2026-01-16T16:17:22.160083Z",
     "iopub.status.idle": "2026-01-16T16:17:22.653255Z",
     "shell.execute_reply": "2026-01-16T16:17:22.652098Z"
    },
    "papermill": {
     "duration": 0.502758,
     "end_time": "2026-01-16T16:17:22.655583",
     "exception": false,
     "start_time": "2026-01-16T16:17:22.152825",
     "status": "completed"
    },
    "tags": []
   },
   "outputs": [],
   "source": [
    "submission = pd.read_csv(CFG.sample_submission_csv)\n",
    "test_id = test[\"id\"]\n",
    "submission = pd.DataFrame({\n",
    "    'Id': test_id, \n",
    "    'exam_score': y_pred   \n",
    "})\n",
    "\n",
    "submission.to_csv('submission.csv', index=False)"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 13,
   "id": "722c9d46",
   "metadata": {
    "execution": {
     "iopub.execute_input": "2026-01-16T16:17:22.670423Z",
     "iopub.status.busy": "2026-01-16T16:17:22.669457Z",
     "iopub.status.idle": "2026-01-16T16:17:22.679322Z",
     "shell.execute_reply": "2026-01-16T16:17:22.678386Z"
    },
    "papermill": {
     "duration": 0.01951,
     "end_time": "2026-01-16T16:17:22.681304",
     "exception": false,
     "start_time": "2026-01-16T16:17:22.661794",
     "status": "completed"
    },
    "tags": []
   },
   "outputs": [
    {
     "data": {
      "text/html": [
       "<div>\n",
       "<style scoped>\n",
       "    .dataframe tbody tr th:only-of-type {\n",
       "        vertical-align: middle;\n",
       "    }\n",
       "\n",
       "    .dataframe tbody tr th {\n",
       "        vertical-align: top;\n",
       "    }\n",
       "\n",
       "    .dataframe thead th {\n",
       "        text-align: right;\n",
       "    }\n",
       "</style>\n",
       "<table border=\"1\" class=\"dataframe\">\n",
       "  <thead>\n",
       "    <tr style=\"text-align: right;\">\n",
       "      <th></th>\n",
       "      <th>Id</th>\n",
       "      <th>exam_score</th>\n",
       "    </tr>\n",
       "  </thead>\n",
       "  <tbody>\n",
       "    <tr>\n",
       "      <th>0</th>\n",
       "      <td>630000</td>\n",
       "      <td>71.302765</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>1</th>\n",
       "      <td>630001</td>\n",
       "      <td>69.961716</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>2</th>\n",
       "      <td>630002</td>\n",
       "      <td>87.676155</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>3</th>\n",
       "      <td>630003</td>\n",
       "      <td>55.216450</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>4</th>\n",
       "      <td>630004</td>\n",
       "      <td>47.592976</td>\n",
       "    </tr>\n",
       "  </tbody>\n",
       "</table>\n",
       "</div>"
      ],
      "text/plain": [
       "       Id  exam_score\n",
       "0  630000   71.302765\n",
       "1  630001   69.961716\n",
       "2  630002   87.676155\n",
       "3  630003   55.216450\n",
       "4  630004   47.592976"
      ]
     },
     "execution_count": 13,
     "metadata": {},
     "output_type": "execute_result"
    }
   ],
   "source": [
    "submission.head()"
   ]
  }
 ],
 "metadata": {
  "kaggle": {
   "accelerator": "none",
   "dataSources": [
    {
     "databundleVersionId": 14993753,
     "sourceId": 119082,
     "sourceType": "competition"
    }
   ],
   "dockerImageVersionId": 31234,
   "isGpuEnabled": false,
   "isInternetEnabled": true,
   "language": "python",
   "sourceType": "notebook"
  },
  "kernelspec": {
   "display_name": "Python 3",
   "language": "python",
   "name": "python3"
  },
  "language_info": {
   "codemirror_mode": {
    "name": "ipython",
    "version": 3
   },
   "file_extension": ".py",
   "mimetype": "text/x-python",
   "name": "python",
   "nbconvert_exporter": "python",
   "pygments_lexer": "ipython3",
   "version": "3.12.12"
  },
  "papermill": {
   "default_parameters": {},
   "duration": 3766.461277,
   "end_time": "2026-01-16T16:17:25.307510",
   "environment_variables": {},
   "exception": null,
   "input_path": "__notebook__.ipynb",
   "output_path": "__notebook__.ipynb",
   "parameters": {},
   "start_time": "2026-01-16T15:14:38.846233",
   "version": "2.6.0"
  }
 },
 "nbformat": 4,
 "nbformat_minor": 5
}
